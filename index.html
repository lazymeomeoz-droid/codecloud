<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#06080d">
  <title>CodeCloud VPS</title>
  <script>
    (function() {
      const theme = localStorage.getItem('cc_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      if (!localStorage.getItem('cc_current_user')) {
        window.location.href = 'login.html';
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
  <style>
    :root {
      --bg-base: #06080d;
      --bg-card: rgba(15, 20, 35, 0.75);
      --bg-card-hover: rgba(20, 28, 50, 0.85);
      --bg-input: rgba(25, 35, 60, 0.5);
      --border: rgba(99, 102, 241, 0.15);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --primary: #818cf8;
      --primary-rgb: 129, 140, 248;
      --primary-dim: rgba(129, 140, 248, 0.12);
      --accent: #a78bfa;
      --accent-rgb: 167, 139, 250;
      --success: #34d399;
      --success-dim: rgba(52, 211, 153, 0.12);
      --error: #f87171;
      --error-dim: rgba(248, 113, 113, 0.12);
      --warning: #fbbf24;
      --warning-dim: rgba(251, 191, 36, 0.12);
      --info: #60a5fa;
      --radius: 18px;
      --radius-sm: 12px;
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --sidebar-w: 280px;
    }

    [data-theme="light"] {
      --bg-base: #f1f5f9;
      --bg-card: rgba(255, 255, 255, 0.85);
      --bg-card-hover: rgba(255, 255, 255, 0.95);
      --bg-input: rgba(241, 245, 249, 0.8);
      --border-subtle: rgba(0, 0, 0, 0.08);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --primary: #6366f1;
      --primary-rgb: 99, 102, 241;
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Aurora Background */
    .bg-aurora {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
      background: linear-gradient(135deg, #06080d 0%, #0c1222 50%, #0a0a1a 100%);
    }

    [data-theme="light"] .bg-aurora {
      background: linear-gradient(135deg, #e0e7ff 0%, #f1f5f9 50%, #dbeafe 100%);
    }

    .aurora-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.5;
      animation: float 25s ease-in-out infinite;
    }

    .orb-1 {
      width: 700px; height: 700px;
      background: radial-gradient(circle, rgba(var(--primary-rgb), 0.3), transparent 70%);
      top: -250px; left: -150px;
    }

    .orb-2 {
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(var(--accent-rgb), 0.25), transparent 70%);
      bottom: -200px; right: -150px;
      animation-delay: -12s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(40px, -40px) scale(1.05); }
      50% { transform: translate(-20px, 30px) scale(0.98); }
      75% { transform: translate(30px, 20px) scale(1.02); }
    }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-primary);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: var(--primary-dim);
      color: var(--primary);
      border-color: rgba(var(--primary-rgb), 0.2);
    }

    .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }

    /* User Card */
    .user-card {
      margin-top: auto;
      padding: 18px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .user-avatar {
      width: 42px; height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      display: flex; align-items: center; justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: white;
    }

    .user-meta h4 { font-size: 0.9rem; font-weight: 700; }
    .user-meta p { font-size: 0.8rem; color: var(--text-muted); }

    .btn-logout {
      width: 100%;
      padding: 11px;
      background: transparent;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    .btn-logout:hover {
      background: var(--error-dim);
      color: var(--error);
      border-color: rgba(248, 113, 113, 0.25);
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: var(--sidebar-w);
      padding: 32px;
      max-width: 100%;
    }

    @media (max-width: 1024px) {
      .main { margin-left: 0; padding: 20px; }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-btn {
      display: none;
      width: 46px; height: 46px;
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 1024px) {
      .menu-btn { display: flex; }
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn-icon {
      width: 44px; height: 44px;
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--bg-card-hover);
      color: var(--primary);
      border-color: var(--border);
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      margin-bottom: 24px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 22px 26px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 4px; height: 20px;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      border-radius: 4px;
    }

    .card-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .card-body { padding: 26px; }

    /* Grid */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 24px;
    }

    @media (max-width: 1100px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    /* Plan Cards */
    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
    }

    .plan-card {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid transparent;
      border-radius: 16px;
      padding: 18px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .plan-card:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-3px);
    }

    .plan-card.active {
      background: var(--primary-dim);
      border-color: var(--primary);
      box-shadow: 0 0 32px rgba(var(--primary-rgb), 0.2);
    }

    .plan-icon {
      width: 48px; height: 48px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .plan-info h4 { font-size: 0.95rem; font-weight: 700; }
    .plan-info p { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

    /* Form Elements */
    .form-group { margin-bottom: 22px; }

    .label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: inherit;
      transition: all 0.2s;
      outline: none;
    }

    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.12);
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px 24px;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      border: none;
      font-family: inherit;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      box-shadow: 0 8px 24px rgba(var(--primary-rgb), 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 40px rgba(var(--primary-rgb), 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
      padding: 12px 16px;
      width: auto;
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--error-dim);
      color: var(--error);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.2);
    }

    .btn-sm {
      padding: 10px 16px;
      font-size: 0.85rem;
    }

    /* Progress */
    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 14px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 10px;
      transition: width 0.5s ease;
      width: 0%;
    }

    /* Terminal */
    .terminal {
      background: #0c1222;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 18px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      height: 300px;
      overflow-y: auto;
      color: #94a3b8;
    }

    .log-entry {
      display: flex;
      gap: 12px;
      padding: 7px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .log-time {
      color: var(--text-muted);
      font-size: 0.75rem;
      min-width: 70px;
    }

    .log-msg { flex: 1; word-break: break-word; }
    .log-info { color: #60a5fa; }
    .log-success { color: #34d399; }
    .log-error { color: #f87171; }
    .log-warn { color: #fbbf24; }

    /* Connection Info */
    .conn-empty {
      text-align: center;
      padding: 36px;
      color: var(--text-muted);
    }

    .conn-field { margin-bottom: 14px; }

    /* Instance Cards */
    .instances-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .instance-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      padding: 22px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .instance-icon {
      width: 52px; height: 52px;
      border-radius: 14px;
      background: var(--success-dim);
      color: var(--success);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instance-info { flex: 1; }
    .instance-info h4 { font-size: 0.95rem; font-weight: 700; margin-bottom: 4px; }
    .instance-info p { font-size: 0.8rem; color: var(--text-muted); }

    /* Views */
    .view { display: none; }
    .view.active { display: block; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      padding: 16px 24px;
      background: var(--bg-card);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateY(120px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .toast.active { transform: translateY(0); opacity: 1; }
    .toast-success { border-left: 4px solid var(--success); color: var(--success); }
    .toast-error { border-left: 4px solid var(--error); color: var(--error); }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: var(--bg-card);
      backdrop-filter: blur(24px);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      padding: 36px;
      max-width: 440px;
      width: 100%;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .modal-content h3 { margin-bottom: 24px; font-size: 1.2rem; }

    /* Overlay */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 99;
    }

    .overlay.active { display: block; }

    /* Hidden */
    .hidden { display: none !important; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
  </style>
</head>
<body>

<div class="bg-aurora">
  <div class="aurora-orb orb-1"></div>
  <div class="aurora-orb orb-2"></div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
      </div>
      <div class="brand-text">
        <h1>CodeCloud</h1>
        <span>Free VPS Platform</span>
      </div>
    </div>

    <nav class="nav-menu">
      <button class="nav-item active" data-view="deploy">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Deploy VPS
      </button>
      <button class="nav-item" data-view="instances">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        My Instances
      </button>
      <button class="nav-item" data-view="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </button>
      <button class="nav-item hidden" id="nav-admin" onclick="location.href='admin.html'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Admin Panel
      </button>
    </nav>

    <div class="user-card">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-meta">
          <h4 id="user-name">User</h4>
          <p id="user-balance">Loading...</p>
        </div>
      </div>
      <button class="btn-logout" id="btn-logout">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <header class="header">
      <div class="header-left">
        <button class="menu-btn" id="menu-btn" onclick="toggleSidebar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
        <h1 class="page-title" id="page-title">Deploy VPS</h1>
      </div>
      <div class="header-actions">
        <button class="btn-icon" id="theme-toggle" title="Toggle Theme">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </div>
    </header>

    <!-- Deploy View -->
    <div id="view-deploy" class="view active">
      <div class="grid-2">
        <!-- Left Column -->
        <div>
          <div class="card">
            <div class="card-header">
              <div>
                <h3 class="card-title">1. Select Environment</h3>
                <p class="card-desc">Choose operating system and connection type</p>
              </div>
            </div>
            <div class="card-body">
              <div class="plans-grid" id="plans-grid"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <h3 class="card-title">2. Configuration</h3>
                <p class="card-desc">Customize your server settings</p>
              </div>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="label">Server Name</label>
                <div class="input-row">
                  <input type="text" id="repo-name" class="input" readonly>
                  <button class="btn-icon" id="btn-regenerate" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                  </button>
                </div>
              </div>

              <div class="form-group hidden" id="ngrok-group">
                <label class="label">Ngrok Token</label>
                <input type="password" id="ngrok-token" class="input" placeholder="Enter your Ngrok authtoken">
              </div>

              <div class="form-group">
                <div class="flex-between">
                  <label class="label">Duration</label>
                  <span style="font-weight:700;color:var(--primary)" id="duration-display">60m</span>
                </div>
                <input type="range" id="duration-slider" min="30" max="330" step="30" value="60" style="width:100%;accent-color:var(--primary)">
              </div>

              <button class="btn btn-primary" id="btn-deploy">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Deploy Now
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div>
          <div class="card hidden" id="progress-card">
            <div class="card-header">
              <div>
                <h3 class="card-title">Deployment Status</h3>
              </div>
            </div>
            <div class="card-body">
              <div class="flex-between">
                <span id="progress-text" style="font-weight:600">Initializing...</span>
                <span id="progress-percent" style="color:var(--primary);font-weight:700">0%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
              </div>
              <div class="terminal" id="logs"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Connection Info</h3>
            </div>
            <div class="card-body">
              <div id="conn-info">
                <div class="conn-empty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="opacity:0.3;margin-bottom:12px"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                  <p>Deploy a VPS to see connection details</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Instances View -->
    <div id="view-instances" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Active Instances</h3>
          <button class="btn-icon" onclick="renderInstances()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div class="card-body">
          <div class="instances-grid" id="instances-grid"></div>
        </div>
      </div>
    </div>

    <!-- Settings View -->
    <div id="view-settings" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Settings</h3>
        </div>
        <div class="card-body">
          <button class="btn btn-danger" id="btn-clear-data" style="max-width:320px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Clear Local Data
          </button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Captcha Modal -->
<div class="modal" id="captcha-modal">
  <div class="modal-content">
    <h3>Security Verification</h3>
    <div class="h-captcha" data-sitekey="a044fd58-a078-46ca-9f5e-71a6ecbcd500" data-callback="onCaptchaSuccess"></div>
    <button class="btn btn-ghost" onclick="$('#captcha-modal').classList.remove('active')" style="margin-top:18px;width:auto">Cancel</button>
  </div>
</div>

<script>
  // Constants
  const PLANS = [
    { id: 'ubuntu_web', name: 'Ubuntu', desc: 'XFCE Desktop', icon: 'ðŸ§' },
    { id: 'win_web', name: 'Windows Web', desc: 'In-Browser', icon: 'ðŸªŸ' },
    { id: 'win_rdp', name: 'Windows RDP', desc: 'Remote Desktop', icon: 'ðŸ–¥ï¸' },
    { id: 'win_tailscale', name: 'Tailscale', desc: 'Private Network', icon: 'ðŸ”’' }
  ];
  const ADMINS = ['vanmanh', 'depchai'];

  // Helpers
  window.$ = s => document.querySelector(s);
  window.$$ = s => document.querySelectorAll(s);

  function showToast(msg, type = 'success') {
    const t = $('#toast');
    t.textContent = msg;
    t.className = `toast toast-${type} active`;
    setTimeout(() => t.classList.remove('active'), 3500);
  }

  function toggleSidebar() {
    $('#sidebar').classList.toggle('open');
    $('#overlay').classList.toggle('active');
  }

  function generateRepoName() {
    return 'vps-' + Math.floor(Math.random() * 100000);
  }

  // Auth Check
  let currentUser = null;
  try {
    currentUser = JSON.parse(localStorage.getItem('cc_current_user'));
    if (!currentUser) throw new Error();
    $('#user-name').textContent = currentUser.username;
    $('#user-avatar').textContent = currentUser.username[0].toUpperCase();
    $('#user-balance').textContent = currentUser.isAdmin ? 'Administrator' : 'Free Plan';
    if (ADMINS.includes(currentUser.username.toLowerCase()) || currentUser.isAdmin) {
      $('#nav-admin').classList.remove('hidden');
    }
  } catch {
    location.href = 'login.html';
  }

  // Logout
  $('#btn-logout').onclick = () => {
    localStorage.removeItem('cc_current_user');
    location.href = 'login.html';
  };

  // Theme Toggle
  $('#theme-toggle').onclick = () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('cc_theme', next);
  };

  // Navigation
  $$('.nav-item[data-view]').forEach(btn => {
    btn.onclick = () => {
      $$('.nav-item').forEach(n => n.classList.remove('active'));
      btn.classList.add('active');
      $$('.view').forEach(v => v.classList.remove('active'));
      $(`#view-${btn.dataset.view}`).classList.add('active');
      $('#page-title').textContent = btn.textContent.trim();
      if (window.innerWidth <= 1024) toggleSidebar();
      if (btn.dataset.view === 'instances') renderInstances();
    };
  });

  // Render Plans
  let selectedPlan = PLANS[0];
  const plansGrid = $('#plans-grid');
  PLANS.forEach(plan => {
    const el = document.createElement('div');
    el.className = `plan-card ${plan.id === selectedPlan.id ? 'active' : ''}`;
    el.innerHTML = `
      <div class="plan-icon">${plan.icon}</div>
      <div class="plan-info">
        <h4>${plan.name}</h4>
        <p>${plan.desc}</p>
      </div>
    `;
    el.onclick = () => {
      $$('.plan-card').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      selectedPlan = plan;
      if (plan.id === 'win_rdp') $('#ngrok-group').classList.remove('hidden');
      else $('#ngrok-group').classList.add('hidden');
    };
    plansGrid.appendChild(el);
  });

  // Repo Name
  $('#repo-name').value = generateRepoName();
  $('#btn-regenerate').onclick = () => $('#repo-name').value = generateRepoName();

  // Duration
  $('#duration-slider').oninput = e => $('#duration-display').textContent = e.target.value + 'm';

  // Deploy
  let isDeploying = false;
  $('#btn-deploy').onclick = () => {
    if (isDeploying) return;
    $('#captcha-modal').classList.add('active');
  };

  window.onCaptchaSuccess = () => {
    $('#captcha-modal').classList.remove('active');
    startDeploy();
  };

  async function startDeploy() {
    isDeploying = true;
    $('#progress-card').classList.remove('hidden');
    const btn = $('#btn-deploy');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20" style="animation:spin 1s linear infinite"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg> Deploying...';
    btn.disabled = true;

    const logs = $('#logs');
    logs.innerHTML = '';
    const addLog = (msg, type = 'info') => {
      logs.innerHTML += `<div class="log-entry"><span class="log-time">${new Date().toLocaleTimeString()}</span><span class="log-msg log-${type}">${msg}</span></div>`;
      logs.scrollTop = logs.scrollHeight;
    };

    addLog('Starting deployment...', 'info');
    $('#progress-fill').style.width = '20%';
    $('#progress-percent').textContent = '20%';

    try {
      const res = await fetch('/api/vps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          planId: selectedPlan.id,
          durationMinutes: parseInt($('#duration-slider').value),
          repoName: $('#repo-name').value,
          ngrokToken: $('#ngrok-token').value,
          repoVisibility: 'public',
          username: currentUser.username
        })
      });
      const data = await res.json();

      if (!data.success) throw new Error(data.message);

      addLog('Repository created: ' + data.repoUrl, 'success');
      $('#progress-fill').style.width = '50%';
      $('#progress-percent').textContent = '50%';

      addLog('Waiting for VPS to start...', 'warn');
      let checks = 0;
      const poll = setInterval(async () => {
        checks++;
        if (checks > 45) {
          clearInterval(poll);
          addLog('Timeout waiting for VPS link', 'error');
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          isDeploying = false;
          return;
        }

        try {
          const findRes = await fetch('/api/find-link', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ owner: data.owner, repoName: data.repoUrl.split('/').pop() })
          });
          const findData = await findRes.json();

          if (findData.found) {
            clearInterval(poll);
            $('#progress-fill').style.width = '100%';
            $('#progress-percent').textContent = '100%';
            addLog('VPS Ready!', 'success');
            showToast('VPS Deployed Successfully!');

            $('#conn-info').innerHTML = `
              <div class="conn-field">
                <label class="label">Connect URL</label>
                <input class="input" readonly value="${findData.vpsLink}" onclick="this.select();document.execCommand('copy');showToast('Copied!')">
              </div>
              <div class="conn-field">
                <label class="label">Password</label>
                <input class="input" readonly value="${findData.vpsPassword || data.vpsPassword}" onclick="this.select();document.execCommand('copy');showToast('Copied!')">
              </div>
              <p style="font-size:0.8rem;color:var(--text-muted);margin-top:12px;text-align:center">Click to copy</p>
            `;

            // Save to local storage
            const list = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
            list.push({
              repo: data.repoUrl.split('/').pop(),
              owner: data.owner,
              plan: selectedPlan.name,
              created: new Date().toLocaleString()
            });
            localStorage.setItem('cc_vps_list', JSON.stringify(list));

            btn.disabled = false;
            btn.innerHTML = originalHTML;
            isDeploying = false;
          } else if (findData.message) {
            $('#progress-text').textContent = findData.message.slice(0, 55);
            if (findData.progress) {
              $('#progress-fill').style.width = findData.progress + '%';
              $('#progress-percent').textContent = findData.progress + '%';
            }
          }
        } catch (e) {
          // Ignore polling errors
        }
      }, 5000);

    } catch (e) {
      addLog(e.message, 'error');
      btn.disabled = false;
      btn.innerHTML = originalHTML;
      isDeploying = false;
    }
  }

  // Instances
  function renderInstances() {
    const list = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
    const grid = $('#instances-grid');
    grid.innerHTML = '';

    if (list.length === 0) {
      grid.innerHTML = `
        <div class="conn-empty" style="grid-column:1/-1">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="opacity:0.3;margin-bottom:12px"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          <p>No active instances</p>
        </div>
      `;
      return;
    }

    list.forEach((vps, idx) => {
      const el = document.createElement('div');
      el.className = 'instance-card';
      el.innerHTML = `
        <div class="instance-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="instance-info">
          <h4>${vps.repo}</h4>
          <p>${vps.plan} â€¢ ${vps.created}</p>
        </div>
        <button class="btn btn-danger btn-sm" onclick="deleteVps(${idx}, '${vps.owner}', '${vps.repo}')">Delete</button>
      `;
      grid.appendChild(el);
    });
  }

  window.deleteVps = async (idx, owner, repo) => {
    if (!confirm('Delete this VPS?')) return;
    try {
      await fetch('/api/delete-vps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ owner, repo })
      });
      const list = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
      list.splice(idx, 1);
      localStorage.setItem('cc_vps_list', JSON.stringify(list));
      renderInstances();
      showToast('VPS Deleted');
    } catch (e) {
      showToast('Error deleting VPS', 'error');
    }
  };

  // Settings
  $('#btn-clear-data').onclick = () => {
    if (confirm('Clear all local data? You will be logged out.')) {
      localStorage.clear();
      location.reload();
    }
  };
</script>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

</body>
</html>
