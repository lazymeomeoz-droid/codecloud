<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0E14">
  <title>CodeCloud VPS</title>
  <script>
    (function() {
      var theme = localStorage.getItem('cc_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      if (!localStorage.getItem('cc_current_user')) {
        window.location.href = 'login.html';
      }
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
  <style>
    :root {
      /* Cosmic Glass Theme - Light */
      --bg-base: #eef2f6;
      --bg-grad-start: #eef2f6; --bg-grad-end: #e2e8f0;
      --glass-surface: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.6);
      --glass-highlight: rgba(255, 255, 255, 0.8);
      --text-main: #1e293b; --text-sec: #64748b; --text-muted: #94a3b8;
      --primary: #6366f1; --primary-glow: rgba(99, 102, 241, 0.4);
      --accent: #8b5cf6; --accent-glow: rgba(139, 92, 246, 0.4);
      --success: #10b981; --error: #ef4444; --warning: #f59e0b;
      --radius-sm: 8px; --radius-md: 16px; --radius-lg: 24px;
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --sidebar-w: 260px;
      --font-sans: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    [data-theme="dark"] {
      /* Cosmic Glass Theme - Dark */
      --bg-base: #02040a;
      --bg-grad-start: #02040a; --bg-grad-end: #0f172a;
      --glass-surface: rgba(18, 24, 38, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --text-main: #f8fafc; --text-sec: #94a3b8; --text-muted: #64748b;
      --primary: #818cf8; --primary-glow: rgba(129, 140, 248, 0.25);
      --accent: #a78bfa; --accent-glow: rgba(167, 139, 250, 0.25);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: var(--font-sans); background: var(--bg-base); color: var(--text-main); 
      min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; 
    }

    /* --- Background Aurora --- */
    .bg-effects { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; background: radial-gradient(circle at top center, #1e1b4b 0%, #020617 100%); }
    [data-theme="light"] .bg-effects { background: radial-gradient(circle at top center, #e0e7ff 0%, #f1f5f9 100%); }
    
    .aurora {
      position: absolute; width: 140%; height: 140%; top: -20%; left: -20%;
      background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.15), transparent 60%),
                  radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.1), transparent 50%);
      filter: blur(80px); animation: auroraMove 20s infinite alternate ease-in-out;
    }
    @keyframes auroraMove { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(-5%, 5%) scale(1.1); } }

    /* --- Layout --- */
    .app-layout { display: flex; min-height: 100vh; }
    
    /* --- Sidebar --- */
    .sidebar {
      width: var(--sidebar-w); background: var(--glass-surface);
      backdrop-filter: blur(24px); border-right: 1px solid var(--glass-border);
      display: flex; flex-direction: column; padding: 24px;
      position: fixed; top: 0; bottom: 0; left: 0; z-index: 50;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @media(max-width: 1024px) { .sidebar { transform: translateX(-100%); box-shadow: var(--shadow-lg); } .sidebar.active { transform: translateX(0); } }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding-left: 8px; }
    .logo-box { 
      width: 40px; height: 40px; border-radius: 12px; 
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px var(--primary-glow);
      color: white;
    }
    .brand h1 { font-size: 1.25rem; font-weight: 800; background: linear-gradient(to right, var(--text-main), var(--text-sec)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .nav-menu { display: flex; flex-direction: column; gap: 6px; flex: 1; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-radius: 12px; color: var(--text-sec); font-weight: 600; font-size: 0.9rem;
      cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
      background: transparent;
    }
    .nav-item:hover { background: var(--glass-highlight); color: var(--text-main); transform: translateX(2px); }
    .nav-item.active { 
      background: rgba(99, 102, 241, 0.1); color: var(--primary); 
      border-color: rgba(99, 102, 241, 0.2); 
    }
    .nav-item svg { width: 20px; height: 20px; }

    .user-card {
      margin-top: auto; padding: 16px; background: var(--glass-highlight);
      border-radius: 16px; border: 1px solid var(--glass-border);
      display: flex; gap: 12px; align-items: center;
    }
    .user-avatar { 
      width: 36px; height: 36px; border-radius: 10px; 
      background: linear-gradient(135deg, var(--accent), var(--primary));
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: 700; font-size: 0.9rem;
    }
    .user-meta h4 { font-size: 0.85rem; font-weight: 700; }
    .user-meta p { font-size: 0.75rem; color: var(--text-sec); }

    /* --- Main Content --- */
    .main-content { flex: 1; margin-left: var(--sidebar-w); padding: 32px; max-width: 1600px; width: 100%; }
    @media(max-width: 1024px) { .main-content { margin-left: 0; padding: 20px; } }

    .top-header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--glass-border); 
    }
    .page-title { font-size: 1.75rem; font-weight: 800; letter-spacing: -0.02em; }
    .menu-toggle { display: none; background: none; border: none; color: var(--text-main); cursor: pointer; }
    @media(max-width: 1024px) { .menu-toggle { display: block; } }

    /* --- Theme Toggle --- */
    .theme-btn {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--glass-surface); border: 1px solid var(--glass-border);
      color: var(--text-sec); cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: 0.2s;
    }
    .theme-btn:hover { background: var(--glass-highlight); color: var(--primary); transform: translateY(-2px); }

    /* --- Cards & Panels --- */
    .panel {
      background: var(--glass-surface); backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: var(--radius-lg);
      padding: 28px; margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .panel:hover { box-shadow: var(--shadow-lg); border-color: rgba(255,255,255,0.15); }
    
    .panel-header { margin-bottom: 24px; }
    .panel-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
    .panel-title::before { content: ''; width: 4px; height: 18px; background: var(--primary); border-radius: 4px; }
    .panel-desc { font-size: 0.85rem; color: var(--text-sec); margin-top: 4px; margin-left: 12px; }

    /* --- Grid Layouts --- */
    .grid-2 { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 24px; }
    @media(max-width: 1100px) { .grid-2 { grid-template-columns: 1fr; } }

    /* --- Selection Cards --- */
    .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .select-card {
      background: var(--glass-highlight); border: 2px solid transparent;
      border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; gap: 12px;
    }
    .select-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.03); }
    .select-card.active {
      background: rgba(99, 102, 241, 0.08); border-color: var(--primary);
      box-shadow: 0 0 20px var(--primary-glow);
    }
    .card-icon { 
      width: 42px; height: 42px; border-radius: 10px; 
      background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }
    .card-info h4 { font-size: 0.9rem; font-weight: 700; }
    .card-info p { font-size: 0.75rem; color: var(--text-sec); }

    /* --- Form Elements --- */
    .form-group { margin-bottom: 20px; }
    .label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-sec); margin-bottom: 8px; }
    .input {
      width: 100%; background: var(--glass-highlight); border: 1px solid var(--glass-border);
      padding: 14px 16px; border-radius: 12px; color: var(--text-main); font-family: inherit;
      transition: 0.2s;
    }
    .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); background: rgba(255,255,255,0.05); }
    
    /* --- Buttons --- */
    .btn {
      width: 100%; padding: 16px; border-radius: 12px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      position: relative; overflow: hidden;
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary), var(--accent)); color: white;
      box-shadow: 0 8px 16px -4px var(--primary-glow);
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 20px -4px var(--primary-glow); filter: brightness(1.1); }
    .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.2); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.25); transform: translateY(-2px); }
    .btn-ghost { background: transparent; color: var(--text-sec); }
    .btn-ghost:hover { color: var(--text-main); background: var(--glass-highlight); }

    /* --- Logs & Terminal --- */
    .terminal {
      background: #0f172a; border-radius: 16px; padding: 20px;
      font-family: var(--font-mono); font-size: 0.85rem; color: #cbd5e1;
      height: 300px; overflow-y: auto; border: 1px solid var(--glass-border);
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
    }
    .log-entry { display: flex; gap: 12px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-time { color: #64748b; font-size: 0.75rem; min-width: 70px; }
    .log-msg { flex: 1; word-break: break-word; }
    .log-info { color: #60a5fa; } .log-success { color: #34d399; } .log-error { color: #f87171; } .log-warn { color: #fbbf24; }

    /* --- Progress --- */
    .progress-wrap { height: 8px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; margin: 16px 0; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s ease; }

    /* --- Utils --- */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    
    /* --- Toast --- */
    .toast { 
      position: fixed; bottom: 30px; right: 30px; padding: 16px 24px; 
      background: var(--glass-surface); backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: 12px;
      box-shadow: var(--shadow-lg); z-index: 100; transform: translateY(100px); opacity: 0;
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex; align-items: center; gap: 12px; font-weight: 600;
    }
    .toast.active { transform: translateY(0); opacity: 1; }
    .toast-success { color: var(--success); border-left: 4px solid var(--success); }
    .toast-error { color: var(--error); border-left: 4px solid var(--error); }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.4); }
  </style>
</head>
<body>

  <div class="bg-effects"><div class="aurora"></div></div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="24" height="24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>
        </div>
        <h1>CodeCloud</h1>
      </div>

      <nav class="nav-menu">
        <button class="nav-item active" data-target="create">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Deploy VPS
        </button>
        <button class="nav-item" data-target="manager">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          Instances
        </button>
        <button class="nav-item" data-target="settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </button>
        <button class="nav-item hidden" id="nav-admin" onclick="window.location.href='admin.html'">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Admin Panel
        </button>
      </nav>

      <div class="user-card">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-meta">
          <h4 id="user-display-name">User</h4>
          <p id="user-time-display">Loading...</p>
        </div>
      </div>
      
      <button class="btn btn-ghost" id="logout-btn" style="margin-top: 12px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <header class="top-header">
        <div style="display:flex;align-items:center;gap:16px">
          <button class="menu-toggle" id="menu-toggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
          <h2 class="page-title" id="page-title">Deploy VPS</h2>
        </div>
        <button class="theme-btn" id="theme-toggle">
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
      </header>

      <!-- CREATE VIEW -->
      <div id="view-create">
        <div class="grid-2">
          <!-- Left Column -->
          <div style="display:flex;flex-direction:column;gap:24px">
            
            <div class="panel">
              <div class="panel-header">
                <h3 class="panel-title">1. Select Environment</h3>
                <p class="panel-desc">Choose operating system and connection method</p>
              </div>
              <div class="selection-grid" id="plans-container"></div>
            </div>

            <div class="panel">
              <div class="panel-header">
                 <h3 class="panel-title">2. Configuration</h3>
                 <p class="panel-desc">Set your server details</p>
              </div>
              <div class="form-group">
                <label class="label">Server Name</label>
                <div style="display:flex;gap:10px">
                  <input type="text" id="repo-name" class="input" readonly>
                  <button class="btn btn-ghost" style="width:auto" id="btn-regenerate" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                  </button>
                </div>
              </div>

              <div class="form-group hidden" id="ngrok-group">
                <label class="label">Ngrok Token</label>
                <input type="password" id="ngrok-token" class="input" placeholder="Enter your Ngrok Authtoken">
              </div>

              <div class="form-group">
                <div class="flex-between">
                  <label class="label">Duration</label>
                  <span style="font-weight:700;color:var(--primary)" id="duration-val">60m</span>
                </div>
                <input type="range" id="duration" min="30" max="330" step="30" value="60" style="width:100%;accent-color:var(--primary)">
              </div>

              <button class="btn btn-primary" id="btn-deploy">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                Deploy Now
              </button>
            </div>
          </div>

          <!-- Right Column -->
          <div style="display:flex;flex-direction:column;gap:24px">
            
            <div class="panel hidden" id="progress-panel">
               <div class="panel-header">
                 <h3 class="panel-title">Deployment Status</h3>
               </div>
               <div class="flex-between">
                 <span style="font-weight:600" id="progress-status-text">Initializing...</span>
                 <span style="color:var(--primary);font-weight:700" id="progress-percent">0%</span>
               </div>
               <div class="progress-wrap">
                 <div class="progress-bar" id="progress-bar-fill"></div>
               </div>
               <div class="terminal" id="logs"></div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <h3 class="panel-title">Connection Info</h3>
              </div>
              <div id="conn-info" style="display:flex;flex-direction:column;gap:12px">
                <div class="text-center" style="color:var(--text-sec);padding:20px">No active deployment</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- MANAGER VIEW -->
      <div id="view-manager" class="hidden">
        <div class="panel">
          <div class="panel-header"><h3 class="panel-title">Active Instances</h3></div>
          <div id="vps-list" class="selection-grid"></div>
        </div>
      </div>

      <!-- SETTINGS VIEW -->
      <div id="view-settings" class="hidden">
        <div class="panel">
          <div class="panel-header"><h3 class="panel-title">Settings</h3></div>
          <button class="btn btn-danger" id="btn-clear-data">Clear Local Data</button>
        </div>
      </div>

    </main>
  </div>

  <div id="toast" class="toast"></div>
  
  <!-- Captcha Modal -->
  <div id="captcha-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)">
    <div class="panel" style="width:100%;max-width:400px;text-align:center">
      <h3 style="margin-bottom:20px">Security Check</h3>
      <div class="h-captcha" data-sitekey="a044fd58-a078-46ca-9f5e-71a6ecbcd500" data-callback="onCaptchaSuccess"></div>
      <button class="btn btn-ghost" onclick="document.getElementById('captcha-modal').classList.add('hidden')" style="margin-top:10px">Cancel</button>
    </div>
  </div>

  <script>
    // --- CORE LOGIC (Preserved from original) ---
    const PLANS = [
      { id: 'ubuntu_web', name: 'Ubuntu', desc: 'XFCE Desktop' },
      { id: 'win_web', name: 'Windows Web', desc: 'In-Browser' },
      { id: 'win_rdp', name: 'Windows RDP', desc: 'Remote Desktop' },
      { id: 'win_tailscale', name: 'Tailscale', desc: 'Private Network' }
    ];

    // UI Helpers
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const showToast = (msg, type='success') => {
      const t = $('#toast'); t.innerHTML = msg; t.className = `toast toast-${type} active`;
      setTimeout(() => t.classList.remove('active'), 3000);
    };

    // Render Plans
    const planContainer = $('#plans-container');
    let selectedPlan = PLANS[0];
    PLANS.forEach(p => {
      const el = document.createElement('div');
      el.className = `select-card ${p.id === selectedPlan.id ? 'active' : ''}`;
      el.innerHTML = `
        <div class="card-icon">${p.name[0]}</div>
        <div class="card-info"><h4>${p.name}</h4><p>${p.desc}</p></div>
      `;
      el.onclick = () => {
        $$('.select-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        selectedPlan = p;
        if(p.id === 'win_rdp') $('#ngrok-group').classList.remove('hidden');
        else $('#ngrok-group').classList.add('hidden');
      };
      planContainer.appendChild(el);
    });

    // Navigation
    $$('.nav-item[data-target]').forEach(b => {
      b.onclick = () => {
        $$('.nav-item').forEach(n => n.classList.remove('active'));
        b.classList.add('active');
        $('#view-create').classList.add('hidden');
        $('#view-manager').classList.add('hidden');
        $('#view-settings').classList.add('hidden');
        $(`#view-${b.dataset.target}`).classList.remove('hidden');
        $('#page-title').textContent = b.textContent.trim();
        if(window.innerWidth < 1024) $('#sidebar').classList.remove('active');
        if(b.dataset.target === 'manager') renderManager();
      }
    });

    // Sidebar Toggle
    $('#menu-toggle').onclick = () => $('#sidebar').classList.add('active');
    document.addEventListener('click', e => {
      if(window.innerWidth < 1024 && !e.target.closest('.sidebar') && !e.target.closest('#menu-toggle')) {
        $('#sidebar').classList.remove('active');
      }
    });

    // Theme Toggle
    $('#theme-toggle').onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('cc_theme', next);
    };

    // Mock Data for UI Demo
    $('#repo-name').value = 'vps-' + Math.floor(Math.random()*10000);
    $('#btn-regenerate').onclick = () => $('#repo-name').value = 'vps-' + Math.floor(Math.random()*10000);
    $('#duration').oninput = (e) => $('#duration-val').textContent = e.target.value + 'm';

    // Auth Check
    const user = JSON.parse(localStorage.getItem('cc_current_user') || '{}');
    if(user.username) {
      $('#user-display-name').textContent = user.username;
      $('#user-avatar').textContent = user.username[0].toUpperCase();
      if(['vanmanh','depchai'].includes(user.username)) $('#nav-admin').classList.remove('hidden');
    }

    $('#logout-btn').onclick = () => {
      localStorage.removeItem('cc_current_user');
      location.href = 'login.html';
    };

    // --- DEPLOY LOGIC (Simplified for UI) ---
    let isDeploying = false;
    $('#btn-deploy').onclick = () => {
      if(isDeploying) return;
      $('#captcha-modal').classList.remove('hidden');
    };

    window.onCaptchaSuccess = () => {
      $('#captcha-modal').classList.add('hidden');
      startDeploy();
    };

    async function startDeploy() {
      isDeploying = true;
      $('#progress-panel').classList.remove('hidden');
      const btn = $('#btn-deploy');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Deploying...';
      btn.disabled = true;

      const logs = $('#logs');
      const addLog = (msg, type='info') => logs.innerHTML += `<div class="log-entry"><span class="log-time">${new Date().toLocaleTimeString()}</span><span class="log-msg log-${type}">${msg}</span></div>`;
      
      addLog('Starting deployment...', 'info');
      $('#progress-bar-fill').style.width = '20%';
      $('#progress-percent').textContent = '20%';

      try {
        // Real API Call
        const res = await fetch('/api/vps', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            planId: selectedPlan.id,
            durationMinutes: parseInt($('#duration').value),
            repoName: $('#repo-name').value,
            ngrokToken: $('#ngrok-token').value,
            repoVisibility: 'public',
            username: user.username
          })
        });
        const data = await res.json();
        
        if(!data.success) throw new Error(data.message);

        addLog('Repo created: ' + data.repoUrl, 'success');
        $('#progress-bar-fill').style.width = '50%';
        $('#progress-percent').textContent = '50%';
        
        // Poll for link
        addLog('Waiting for VPS to start...', 'warn');
        let checks = 0;
        const poll = setInterval(async () => {
          checks++;
          if(checks > 30) { clearInterval(poll); addLog('Timeout waiting for link', 'error'); btn.disabled=false; btn.innerHTML=originalText; }
          
          try {
            const findRes = await fetch('/api/find-link', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({owner: data.owner, repoName: data.repoUrl.split('/').pop()})
            });
            const findData = await findRes.json();
            
            if(findData.found) {
              clearInterval(poll);
              $('#progress-bar-fill').style.width = '100%';
              $('#progress-percent').textContent = '100%';
              addLog('VPS Ready!', 'success');
              showToast('VPS Deployed Successfully!');
              
              $('#conn-info').innerHTML = `
                <div class="form-group">
                   <label class="label">Connect URL</label>
                   <input class="input" readonly value="${findData.vpsLink}" onclick="this.select()">
                </div>
                <div class="form-group">
                   <label class="label">Password</label>
                   <input class="input" readonly value="${findData.vpsPassword}" onclick="this.select()">
                </div>
              `;
              
              // Save to local manager
              const vpsList = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
              vpsList.push({ repo: data.repoUrl.split('/').pop(), owner: data.owner, plan: selectedPlan.name, created: new Date().toLocaleString() });
              localStorage.setItem('cc_vps_list', JSON.stringify(vpsList));
              
              btn.disabled = false; 
              btn.innerHTML = originalText;
              isDeploying = false;
            }
          } catch(e) {}
        }, 5000);

      } catch(e) {
        addLog(e.message, 'error');
        btn.disabled = false;
        btn.innerHTML = originalText;
        isDeploying = false;
      }
    }

    function renderManager() {
      const list = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
      const container = $('#vps-list');
      container.innerHTML = '';
      if(list.length === 0) container.innerHTML = '<div class="text-center" style="grid-column:1/-1;padding:20px;color:var(--text-sec)">No active instances</div>';
      
      list.forEach((v, i) => {
        const el = document.createElement('div');
        el.className = 'select-card';
        el.style.cursor = 'default';
        el.innerHTML = `
          <div class="card-icon" style="background:rgba(16, 185, 129, 0.1);color:var(--success)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div class="card-info" style="flex:1">
            <h4>${v.repo}</h4>
            <p>${v.plan} â€¢ ${v.created}</p>
          </div>
          <button class="btn btn-danger" style="width:auto;padding:8px 12px;font-size:0.8rem" onclick="deleteVps(${i}, '${v.owner}', '${v.repo}')">Del</button>
        `;
        container.appendChild(el);
      });
    }

    window.deleteVps = async (idx, owner, repo) => {
      if(!confirm('Delete this VPS?')) return;
      try {
        await fetch('/api/delete-vps', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({owner, repo})
        });
        const list = JSON.parse(localStorage.getItem('cc_vps_list') || '[]');
        list.splice(idx, 1);
        localStorage.setItem('cc_vps_list', JSON.stringify(list));
        renderManager();
        showToast('VPS Deleted');
      } catch(e) { showToast('Error deleting', 'error'); }
    };
    
    $('#btn-clear-data').onclick = () => {
      if(confirm('Clear all local data?')) {
        localStorage.clear();
        location.reload();
      }
    };
  </script>
</body>
</html>