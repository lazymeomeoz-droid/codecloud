<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Panel - CodeCloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: #020617; --bg-surface: rgba(15,23,42,0.85); --bg-card: rgba(30,41,59,0.6); --bg-elevated: #1e293b;
      --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
      --border-light: rgba(139,92,246,0.12); --border-medium: rgba(139,92,246,0.25);
      --accent: #818cf8; --accent-light: #a5b4fc; --accent-soft: rgba(129,140,248,0.12); --accent-glow: rgba(129,140,248,0.3);
      --success: #34d399; --success-soft: rgba(52,211,153,0.12);
      --error: #f87171; --error-soft: rgba(248,113,113,0.12);
      --warning: #fbbf24; --warning-soft: rgba(251,191,36,0.12);
      --info: #38bdf8; --info-soft: rgba(56,189,248,0.12);
      --gradient-primary: linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#d946ef 100%);
      --gradient-accent: linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);
      --shadow-md: 0 4px 20px -2px rgba(0,0,0,0.5); --shadow-lg: 0 20px 40px -10px rgba(0,0,0,0.6);
      --shadow-glow: 0 0 50px rgba(129,140,248,0.2);
      --radius-sm: 8px; --radius-md: 14px; --radius-lg: 20px; --radius-xl: 28px;
      --sidebar-w: 260px;
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:var(--bg-base);color:var(--text-primary);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
    .hidden{display:none!important}
    
    .bg-effects{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
    .aurora{position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,var(--accent-soft) 60deg,transparent 120deg,rgba(34,211,238,0.08) 180deg,transparent 240deg,var(--accent-glow) 300deg,transparent 360deg);animation:auroraRotate 60s linear infinite}
    @keyframes auroraRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    
    .app-layout{display:flex;min-height:100vh;position:relative;z-index:1}
    
    /* Sidebar */
    .sidebar{width:var(--sidebar-w);background:var(--bg-surface);backdrop-filter:blur(40px);border-right:1px solid var(--border-light);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:var(--transition)}
    @media(max-width:1024px){.sidebar{transform:translateX(-100%)}.sidebar.active{transform:translateX(0)}}
    .sidebar-header{padding:20px;border-bottom:1px solid var(--border-light)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:14px;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-glow);animation:float 4s ease-in-out infinite}
    .logo svg{width:28px;height:28px;color:white}
    .brand-text h1{font-size:1.1rem;font-weight:900;background:var(--gradient-primary);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .brand-text p{font-size:0.7rem;color:var(--text-muted)}
    
    .admin-info{padding:16px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(220,38,38,0.05))}
    .admin-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#ef4444,#dc2626);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:1rem}
    .admin-details h4{font-size:0.9rem;font-weight:700}
    .admin-details p{font-size:0.72rem;color:var(--error)}
    
    .nav-menu{padding:16px 12px;display:flex;flex-direction:column;gap:4px;flex:1;overflow-y:auto}
    .nav-section{font-size:0.68rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;padding:12px 12px 8px;margin-top:8px}
    .nav-section:first-child{margin-top:0}
    .nav-item{width:100%;border:none;background:transparent;color:var(--text-secondary);padding:11px 14px;border-radius:var(--radius-md);font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:12px;cursor:pointer;transition:var(--transition);position:relative}
    .nav-item:hover{color:var(--text-primary);background:var(--accent-soft)}
    .nav-item.active{color:white;background:var(--gradient-accent);box-shadow:var(--shadow-md)}
    .nav-item .icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center}
    .nav-item .icon svg{width:18px;height:18px}
    .nav-item .badge{margin-left:auto;padding:2px 8px;border-radius:999px;font-size:0.68rem;font-weight:700;background:var(--error);color:white}
    .nav-item.active .badge{background:rgba(255,255,255,0.3)}
    
    .sidebar-footer{padding:16px 20px;border-top:1px solid var(--border-light)}
    .btn-back{width:100%;padding:12px;border-radius:var(--radius-md);border:1px solid var(--border-light);background:var(--bg-card);color:var(--text-secondary);font-weight:600;font-size:0.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:var(--transition);text-decoration:none}
    .btn-back:hover{background:var(--accent-soft);color:var(--text-primary);border-color:var(--accent)}
    
    .sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);z-index:40;opacity:0;pointer-events:none;transition:opacity var(--transition)}
    .sidebar.active~.sidebar-overlay{opacity:1;pointer-events:auto}
    
    /* Main Content */
    .main-content{flex:1;margin-left:var(--sidebar-w);min-width:0}
    @media(max-width:1024px){.main-content{margin-left:0}}
    
    .top-bar{height:64px;display:flex;align-items:center;padding:0 24px;gap:16px;background:var(--bg-surface);backdrop-filter:blur(40px);border-bottom:1px solid var(--border-light);position:sticky;top:0;z-index:30}
    .menu-btn{background:var(--bg-card);border:1px solid var(--border-light);color:var(--text-primary);cursor:pointer;display:none;padding:10px;border-radius:var(--radius-sm);transition:var(--transition)}
    .menu-btn:hover{background:var(--accent-soft);border-color:var(--accent)}
    .menu-btn svg{width:20px;height:20px}
    @media(max-width:1024px){.menu-btn{display:flex}}
    .page-title{font-size:1.25rem;font-weight:800;background:var(--gradient-primary);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .top-bar-actions{margin-left:auto;display:flex;align-items:center;gap:10px}
    .refresh-indicator{font-size:0.72rem;color:var(--text-muted);display:flex;align-items:center;gap:6px}
    .refresh-indicator.active{color:var(--success)}
    .refresh-indicator .dot{width:8px;height:8px;border-radius:50%;background:var(--text-muted)}
    .refresh-indicator.active .dot{background:var(--success);animation:pulse 2s infinite}
    
    .scroll-area{padding:24px;overflow-y:auto;min-height:calc(100vh - 64px)}
    @media(max-width:768px){.scroll-area{padding:16px}}
    .container{max-width:1400px;margin:0 auto}
    
    /* Stats Grid */
    .stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px}
    @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:480px){.stats-grid{grid-template-columns:1fr}}
    
    .stat-card{background:var(--bg-surface);backdrop-filter:blur(20px);border-radius:var(--radius-lg);padding:20px;border:1px solid var(--border-light);transition:var(--transition);animation:slideUp 0.5s ease-out backwards;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-accent);opacity:0;transition:var(--transition)}
    .stat-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .stat-card:hover::before{opacity:1}
    .stat-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .stat-icon{width:42px;height:42px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center}
    .stat-icon svg{width:22px;height:22px;color:white}
    .stat-icon.purple{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
    .stat-icon.green{background:linear-gradient(135deg,#10b981,#14b8a6)}
    .stat-icon.yellow{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
    .stat-icon.red{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .stat-icon.blue{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
    .stat-trend{font-size:0.72rem;padding:4px 8px;border-radius:999px;font-weight:700}
    .stat-trend.up{background:var(--success-soft);color:var(--success)}
    .stat-trend.down{background:var(--error-soft);color:var(--error)}
    .stat-label{font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
    .stat-value{font-size:1.75rem;font-weight:900;color:var(--text-primary)}
    .stat-sub{font-size:0.72rem;color:var(--text-muted);margin-top:4px}
    
    /* Panels */
    .panel{background:var(--bg-surface);backdrop-filter:blur(30px);border-radius:var(--radius-xl);padding:24px;border:1px solid var(--border-light);box-shadow:var(--shadow-md);margin-bottom:20px;animation:slideUp 0.5s ease-out backwards;position:relative;overflow:hidden}
    .panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-light),transparent);opacity:0.5}
    .panel-header{margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .panel-title{font-size:1.05rem;font-weight:800;color:var(--text-primary);display:flex;align-items:center;gap:10px}
    .panel-title::before{content:'';width:4px;height:24px;background:var(--gradient-accent);border-radius:2px}
    .panel-desc{color:var(--text-muted);font-size:0.8rem;margin-top:4px}
    .panel-actions{display:flex;gap:8px;flex-wrap:wrap}
    
    /* Quick Actions Bar */
    .quick-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;padding:12px;background:var(--bg-card);border-radius:var(--radius-md);border:1px solid var(--border-light)}
    .quick-actions .label{font-size:0.75rem;color:var(--text-muted);font-weight:600;display:flex;align-items:center;margin-right:8px}
    
    /* Forms */
    .form-group{margin-bottom:16px}
    .form-row{display:grid;grid-template-columns:1fr 120px auto;gap:10px;align-items:end}
    @media(max-width:600px){.form-row{grid-template-columns:1fr}}
    .label{font-size:0.8rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px}
    .input{width:100%;background:var(--bg-card);border-radius:var(--radius-md);border:2px solid var(--border-light);padding:12px 14px;font-size:0.9rem;color:var(--text-primary);transition:var(--transition);font-family:inherit}
    .input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-soft)}
    select.input{cursor:pointer;appearance:none;-webkit-appearance:none;padding-right:32px;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:16px}
    .input-group{display:flex;gap:8px}
    .input-group .input{flex:1}
    
    /* Buttons */
    .btn{padding:10px 18px;border-radius:999px;border:none;font-weight:700;font-size:0.82rem;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
    .btn:hover:not(:disabled){transform:translateY(-2px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .btn-primary{background:var(--gradient-accent);color:white;box-shadow:var(--shadow-md)}
    .btn-success{background:linear-gradient(135deg,var(--success),#14b8a6);color:white}
    .btn-danger{background:linear-gradient(135deg,var(--error),#dc2626);color:white}
    .btn-warning{background:linear-gradient(135deg,var(--warning),#f59e0b);color:#1e293b}
    .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:2px solid var(--border-light)}
    .btn-secondary:hover{border-color:var(--accent);background:var(--accent-soft)}
    .btn-sm{padding:7px 12px;font-size:0.75rem}
    .btn-xs{padding:5px 10px;font-size:0.7rem}
    .btn-icon{width:36px;height:36px;padding:0;border-radius:var(--radius-sm)}
    .btn-full{width:100%}
    
    /* Tables */
    .table-wrapper{overflow-x:auto;border-radius:var(--radius-md);border:1px solid var(--border-light)}
    .data-table{width:100%;border-collapse:collapse;min-width:600px}
    .data-table th,.data-table td{padding:14px 12px;text-align:left;border-bottom:1px solid var(--border-light);font-size:0.82rem}
    .data-table th{background:var(--bg-card);font-weight:700;color:var(--text-muted);position:sticky;top:0;text-transform:uppercase;font-size:0.7rem;letter-spacing:0.5px}
    .data-table tbody tr{transition:var(--transition)}
    .data-table tbody tr:hover{background:rgba(255,255,255,0.02)}
    .data-table tbody tr.selected{background:var(--accent-soft)}
    .scrollable-table{max-height:500px;overflow-y:auto}
    
    /* Checkbox */
    .checkbox{width:18px;height:18px;border-radius:4px;border:2px solid var(--border-medium);background:var(--bg-card);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
    .checkbox.checked{background:var(--accent);border-color:var(--accent)}
    .checkbox.checked::after{content:'âœ“';color:white;font-size:12px;font-weight:bold}
    .checkbox:hover{border-color:var(--accent)}
    
    /* Badges */
    .badge{padding:4px 10px;border-radius:999px;font-size:0.7rem;font-weight:700;display:inline-flex;align-items:center;gap:4px}
    .badge-success{background:var(--success-soft);color:var(--success)}
    .badge-warning{background:var(--warning-soft);color:var(--warning)}
    .badge-error{background:var(--error-soft);color:var(--error)}
    .badge-info{background:var(--accent-soft);color:var(--accent)}
    .badge-cyan{background:var(--info-soft);color:var(--info)}
    
    .action-badge{padding:5px 10px;border-radius:var(--radius-sm);font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.3px}
    .action-badge.login{background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(139,92,246,0.2));color:#a5b4fc;border:1px solid rgba(139,92,246,0.3)}
    .action-badge.register{background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(20,184,166,0.2));color:#6ee7b7;border:1px solid rgba(16,185,129,0.3)}
    .action-badge.ban{background:linear-gradient(135deg,rgba(239,68,68,0.2),rgba(220,38,38,0.2));color:#fca5a5;border:1px solid rgba(239,68,68,0.3)}
    .action-badge.unban{background:linear-gradient(135deg,rgba(34,211,238,0.2),rgba(14,165,233,0.2));color:#67e8f9;border:1px solid rgba(34,211,238,0.3)}
    .action-badge.vps{background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(245,158,11,0.2));color:#fcd34d;border:1px solid rgba(251,191,36,0.3)}
    .action-badge.time{background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(139,92,246,0.2));color:#c4b5fd;border:1px solid rgba(168,85,247,0.3)}
    .action-badge.delete{background:linear-gradient(135deg,rgba(236,72,153,0.2),rgba(219,39,119,0.2));color:#f9a8d4;border:1px solid rgba(236,72,153,0.3)}
    
    /* Search & Filters */
    .search-filters{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .search-filters .input{flex:1;min-width:200px}
    .filter-group{display:flex;gap:8px;align-items:center}
    .filter-group select.input{width:auto;min-width:120px}
    
    /* IP Text */
    .ip-text{font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--text-muted);background:var(--bg-card);padding:3px 8px;border-radius:4px}
    
    /* User Row */
    .user-name{font-weight:700;color:var(--text-primary)}
    .user-meta{font-size:0.72rem;color:var(--text-muted);margin-top:2px}
    
    /* Detail Card */
    .detail-card{background:var(--bg-card);border-radius:var(--radius-sm);padding:10px 12px;border:1px solid var(--border-light);min-width:180px;max-width:280px}
    .detail-row{display:flex;justify-content:space-between;align-items:flex-start;padding:3px 0;border-bottom:1px dashed var(--border-light);gap:10px}
    .detail-row:last-child{border-bottom:none}
    .detail-key{font-size:0.68rem;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:0.3px;flex-shrink:0}
    .detail-val{font-size:0.72rem;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;text-align:right;word-break:break-all}
    .detail-empty{color:var(--text-muted);font-style:italic;font-size:0.72rem;padding:8px;text-align:center}
    
    /* VPS Card */
    .vps-card{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;border:1px solid var(--border-light);margin-bottom:12px;transition:var(--transition)}
    .vps-card:hover{border-color:var(--accent);transform:translateY(-2px)}
    .vps-card.expired{opacity:0.6;border-color:var(--error)}
    .vps-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .vps-title{font-weight:800;font-size:0.95rem}
    .vps-timer{font-size:0.8rem;font-weight:700;display:flex;align-items:center;gap:6px}
    .vps-timer.active{color:var(--success)}
    .vps-timer.warning{color:var(--warning)}
    .vps-timer.expired{color:var(--error)}
    .vps-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .vps-actions{display:flex;gap:8px}
    
    /* Progress Bar */
    .progress-bar{height:6px;background:var(--border-light);border-radius:999px;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;border-radius:999px;background:var(--gradient-accent);transition:width 0.5s ease}
    .progress-fill.warning{background:linear-gradient(90deg,var(--warning),#f59e0b)}
    .progress-fill.danger{background:linear-gradient(90deg,var(--error),#dc2626)}
    
    /* Modals */
    .modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease-out}
    .modal.hidden{display:none}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px)}
    .modal-dialog{position:relative;z-index:1;width:100%;max-width:500px;margin:16px;background:var(--bg-elevated);border-radius:var(--radius-xl);padding:24px;border:1px solid var(--border-light);box-shadow:var(--shadow-lg);animation:slideUp 0.3s ease-out;max-height:90vh;overflow-y:auto}
    .modal-dialog.lg{max-width:700px}
    .modal-title{font-size:1.1rem;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:10px}
    .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition);font-size:1.2rem}
    .modal-close:hover{background:var(--error-soft);color:var(--error);transform:rotate(90deg)}
    .modal-body{margin-bottom:20px}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end}
    
    /* User Detail */
    .user-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:500px){.user-detail-grid{grid-template-columns:1fr}}
    .user-detail-item{background:var(--bg-card);border-radius:var(--radius-sm);padding:12px}
    .user-detail-item .label{font-size:0.7rem;color:var(--text-muted);margin-bottom:4px}
    .user-detail-item .value{font-size:0.9rem;font-weight:700;color:var(--text-primary)}
    
    /* Toast */
    .toast{position:fixed;bottom:20px;right:20px;z-index:300;animation:slideUp 0.3s ease-out}
    .toast.hidden{display:none}
    .toast-inner{min-width:260px;max-width:400px;padding:16px 20px;border-radius:var(--radius-lg);display:flex;align-items:center;gap:12px;font-size:0.9rem;font-weight:600;box-shadow:var(--shadow-lg);background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border-light)}
    .toast.toast-success .toast-inner{border-left:4px solid var(--success)}
    .toast.toast-error .toast-inner{border-left:4px solid var(--error)}
    .toast.toast-info .toast-inner{border-left:4px solid var(--accent)}
    
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite}
    .spinner-dark{border-color:var(--border-light);border-top-color:var(--accent)}
    
    /* Scrollbar */
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border-medium);border-radius:10px}
    ::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}
    
    /* Empty State */
    .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
    .empty-state svg{width:48px;height:48px;margin-bottom:16px;opacity:0.5}
    .empty-state h3{font-size:1rem;margin-bottom:8px;color:var(--text-secondary)}
    .empty-state p{font-size:0.85rem}
    
    /* Selection Bar */
    .selection-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg-elevated);border:1px solid var(--border-medium);border-radius:var(--radius-lg);padding:12px 20px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow-lg);z-index:100;animation:slideUp 0.3s ease-out}
    .selection-bar.hidden{display:none}
    .selection-count{font-weight:700;color:var(--accent)}
    .selection-actions{display:flex;gap:8px}
    
    /* Tab pills for logs */
    .log-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
    .log-filter{padding:6px 14px;border-radius:999px;border:1px solid var(--border-light);background:transparent;color:var(--text-muted);font-size:0.75rem;font-weight:600;cursor:pointer;transition:var(--transition)}
    .log-filter:hover{border-color:var(--accent);color:var(--text-primary)}
    .log-filter.active{background:var(--accent);border-color:var(--accent);color:white}
  </style>
</head>
<body>

<div class="bg-effects"><div class="aurora"></div></div>

<div class="app-layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand">
        <div class="logo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
        <div class="brand-text">
          <h1>Admin Panel</h1>
          <p>CodeCloud Management</p>
        </div>
      </div>
    </div>
    
    <div class="admin-info">
      <div class="admin-avatar" id="admin-avatar">A</div>
      <div class="admin-details">
        <h4 id="admin-name">Admin</h4>
        <p>ðŸ”‘ Super Admin</p>
      </div>
    </div>
    
    <nav class="nav-menu">
      <div class="nav-section">Overview</div>
      <button class="nav-item active" data-tab="dashboard">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg></span>
        <span>Dashboard</span>
      </button>
      
      <div class="nav-section">Management</div>
      <button class="nav-item" data-tab="users">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
        <span>Users</span>
        <span class="badge" id="user-count-badge">0</span>
      </button>
      <button class="nav-item" data-tab="vps">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></span>
        <span>Active VPS</span>
        <span class="badge" id="vps-count-badge">0</span>
      </button>
      <button class="nav-item" data-tab="time">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
        <span>Time Manager</span>
      </button>
      
      <div class="nav-section">System</div>
      <button class="nav-item" data-tab="tokens">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
        <span>GitHub Tokens</span>
      </button>
      <button class="nav-item" data-tab="logs">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>
        <span>System Logs</span>
      </button>
      <button class="nav-item" data-tab="health">
        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>
        <span>System Health</span>
      </button>
    </nav>
    
    <div class="sidebar-footer">
      <a href="index.html" class="btn-back"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> Back to Dashboard</a>
    </div>
  </aside>
  
  <div class="sidebar-overlay" id="overlay"></div>
  
  <main class="main-content">
    <header class="top-bar">
      <button class="menu-btn" id="menu-toggle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button>
      <div class="page-title" id="page-title">Dashboard</div>
      <div class="top-bar-actions">
        <div class="refresh-indicator" id="refresh-indicator"><span class="dot"></span> Auto-refresh</div>
        <button class="btn btn-secondary btn-sm" id="btn-refresh-all"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh</button>
      </div>
    </header>
    
    <div class="scroll-area">
      <div class="container">
        
        <!-- TAB: Dashboard -->
        <div class="tab-content active" id="tab-dashboard">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
              </div>
              <div class="stat-label">Total Users</div>
              <div class="stat-value" id="stat-users">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
              </div>
              <div class="stat-label">Total Time Pool</div>
              <div class="stat-value" id="stat-time">0h</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon yellow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg></div>
              </div>
              <div class="stat-label">Active VPS</div>
              <div class="stat-value" id="stat-vps">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
              </div>
              <div class="stat-label">Active Users</div>
              <div class="stat-value" id="stat-active">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
              </div>
              <div class="stat-label">Banned</div>
              <div class="stat-value" id="stat-banned">0</div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div class="panel" style="grid-column:span 1">
              <div class="panel-header"><h2 class="panel-title">Recent Activity</h2></div>
              <div id="recent-activity" style="max-height:300px;overflow-y:auto"></div>
            </div>
            <div class="panel" style="grid-column:span 1">
              <div class="panel-header"><h2 class="panel-title">Quick Actions</h2></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <button class="btn btn-primary btn-full" onclick="switchTab('users')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> Manage Users</button>
                <button class="btn btn-success btn-full" onclick="switchTab('time')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Add Time</button>
                <button class="btn btn-warning btn-full" onclick="switchTab('vps')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg> View VPS</button>
                <button class="btn btn-secondary btn-full" onclick="switchTab('logs')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> View Logs</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- TAB: Users -->
        <div class="tab-content hidden" id="tab-users">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 class="panel-title">User Management</h2>
                <p class="panel-desc">Manage all registered users</p>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-sm" id="btn-export-users"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export CSV</button>
                <button class="btn btn-primary btn-sm" id="btn-refresh-users"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Refresh</button>
              </div>
            </div>
            
            <div class="search-filters">
              <input type="text" id="user-search" class="input" placeholder="ðŸ” Search username or IP..." />
              <div class="filter-group">
                <select id="user-filter" class="input">
                  <option value="all">All Users</option>
                  <option value="active">Active</option>
                  <option value="banned">Banned</option>
                  <option value="hastime">Has Time</option>
                  <option value="notime">No Time</option>
                </select>
              </div>
            </div>
            
            <div class="quick-actions">
              <span class="label">Quick Time:</span>
              <button class="btn btn-xs btn-success" onclick="bulkAddTime(30)">+30m</button>
              <button class="btn btn-xs btn-success" onclick="bulkAddTime(60)">+1h</button>
              <button class="btn btn-xs btn-success" onclick="bulkAddTime(120)">+2h</button>
              <button class="btn btn-xs btn-success" onclick="bulkAddTime(300)">+5h</button>
              <button class="btn btn-xs btn-danger" onclick="bulkBan()">Ban Selected</button>
              <button class="btn btn-xs btn-warning" onclick="bulkUnban()">Unban Selected</button>
            </div>
            
            <div class="table-wrapper scrollable-table">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width:40px"><div class="checkbox" id="select-all-users"></div></th>
                    <th>User</th>
                    <th>Time</th>
                    <th>Register IP</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- TAB: VPS -->
        <div class="tab-content hidden" id="tab-vps">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 class="panel-title">Active VPS Instances</h2>
                <p class="panel-desc">Monitor and manage running VPS</p>
              </div>
              <div class="panel-actions">
                <button class="btn btn-danger btn-sm" id="btn-cleanup-expired"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Cleanup Expired</button>
                <button class="btn btn-primary btn-sm" id="btn-refresh-vps"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Refresh</button>
              </div>
            </div>
            <div id="vps-list"></div>
          </div>
        </div>
        
        <!-- TAB: Time -->
        <div class="tab-content hidden" id="tab-time">
          <div class="panel">
            <div class="panel-header">
              <h2 class="panel-title">Time Management</h2>
            </div>
            
            <div class="form-group">
              <label class="label">Username</label>
              <input type="text" id="time-username" class="input" placeholder="Enter username" list="user-list" />
              <datalist id="user-list"></datalist>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:end">
              <div class="form-group" style="margin:0">
                <label class="label">Minutes</label>
                <input type="number" id="time-minutes" class="input" placeholder="60" min="1" max="9999" value="60" />
              </div>
              <div class="form-group" style="margin:0">
                <label class="label">Operation</label>
                <select id="time-operation" class="input">
                  <option value="add">âž• Add</option>
                  <option value="deduct">âž– Deduct</option>
                  <option value="set">ðŸ”§ Set Fixed</option>
                </select>
              </div>
              <button id="btn-apply-time" class="btn btn-primary">Apply</button>
            </div>
            
            <div style="margin-top:20px">
              <h3 style="font-size:0.9rem;font-weight:700;margin-bottom:12px">Quick Presets</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-success btn-sm" onclick="quickTimePreset(30)">+30 min</button>
                <button class="btn btn-success btn-sm" onclick="quickTimePreset(60)">+1 hour</button>
                <button class="btn btn-success btn-sm" onclick="quickTimePreset(120)">+2 hours</button>
                <button class="btn btn-success btn-sm" onclick="quickTimePreset(300)">+5 hours</button>
                <button class="btn btn-warning btn-sm" onclick="quickTimePreset(600)">+10 hours</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- TAB: Tokens -->
        <div class="tab-content hidden" id="tab-tokens">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 class="panel-title">GitHub Token Pool</h2>
                <p class="panel-desc">Manage PATs for VPS creation</p>
              </div>
              <button class="btn btn-primary btn-sm" id="btn-refresh-tokens"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Refresh</button>
            </div>
            
            <div class="form-group">
              <label class="label">Add New Token</label>
              <div class="input-group">
                <input type="password" id="new-token-input" class="input" placeholder="ghp_xxxxxxxxxxxx" />
                <button id="btn-add-token" class="btn btn-success">Add & Verify</button>
              </div>
            </div>
            
            <div id="token-list" style="margin-top:20px"></div>
          </div>
        </div>
        
        <!-- TAB: Logs -->
        <div class="tab-content hidden" id="tab-logs">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 class="panel-title">System Logs</h2>
                <p class="panel-desc">Activity and event history</p>
              </div>
              <button class="btn btn-primary btn-sm" id="btn-refresh-logs"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Refresh</button>
            </div>
            
            <div class="log-filters">
              <button class="log-filter active" data-type="all">All</button>
              <button class="log-filter" data-type="login">Login</button>
              <button class="log-filter" data-type="register">Register</button>
              <button class="log-filter" data-type="vps">VPS</button>
              <button class="log-filter" data-type="ban">Ban/Unban</button>
              <button class="log-filter" data-type="time">Time</button>
            </div>
            
            <div class="search-filters">
              <input type="text" id="log-search" class="input" placeholder="ðŸ” Search logs..." />
            </div>
            
            <div class="table-wrapper scrollable-table" style="max-height:600px">
              <table class="data-table">
                <thead>
                  <tr>
                    <th style="width:140px">Time</th>
                    <th style="width:100px">User</th>
                    <th style="width:100px">Action</th>
                    <th style="width:120px">IP</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="logs-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- TAB: Health -->
        <div class="tab-content hidden" id="tab-health">
          <div class="panel">
            <div class="panel-header">
              <div>
                <h2 class="panel-title">System Health</h2>
                <p class="panel-desc">Check system status and run diagnostics</p>
              </div>
              <button class="btn btn-primary btn-sm" id="btn-run-health"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Run Check</button>
            </div>
            <div id="health-results"></div>
          </div>
          
          <div class="panel">
            <div class="panel-header">
              <h2 class="panel-title">Manual Cron Trigger</h2>
            </div>
            <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px">Manually trigger the cleanup cron job to check tokens and delete expired VPS.</p>
            <button class="btn btn-warning" id="btn-trigger-cron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Trigger Cron Job</button>
            <div id="cron-result" style="margin-top:16px"></div>
          </div>
        </div>
        
      </div>
    </div>
  </main>
</div>

<!-- Selection Bar -->
<div class="selection-bar hidden" id="selection-bar">
  <span>Selected: <span class="selection-count" id="selection-count">0</span> users</span>
  <div class="selection-actions">
    <button class="btn btn-success btn-sm" onclick="bulkAddTime(60)">+1h All</button>
    <button class="btn btn-danger btn-sm" onclick="bulkBan()">Ban All</button>
    <button class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear</button>
  </div>
</div>

<!-- User Detail Modal -->
<div id="user-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-dialog lg">
    <button class="modal-close" id="user-modal-close">&times;</button>
    <h3 class="modal-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> User Details: <span id="modal-username"></span></h3>
    <div class="modal-body">
      <div class="user-detail-grid" id="user-detail-content"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-success btn-sm" id="modal-add-time">+1h Time</button>
      <button class="btn btn-danger btn-sm" id="modal-ban-user">Ban User</button>
      <button class="btn btn-secondary btn-sm" id="modal-close-btn">Close</button>
    </div>
  </div>
</div>

<!-- Ban Modal -->
<div id="ban-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-dialog">
    <button class="modal-close" id="ban-modal-close">&times;</button>
    <h3 class="modal-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Ban User: <span id="ban-username"></span></h3>
    <div class="modal-body">
      <div class="form-group">
        <label class="label">Ban Duration</label>
        <select id="ban-duration" class="input">
          <option value="1-hours">1 hour</option>
          <option value="6-hours">6 hours</option>
          <option value="12-hours">12 hours</option>
          <option value="24-hours">24 hours</option>
          <option value="3-days">3 days</option>
          <option value="7-days" selected>7 days</option>
          <option value="14-days">14 days</option>
          <option value="30-days">30 days</option>
          <option value="3-months">3 months</option>
          <option value="6-months">6 months</option>
          <option value="12-months">12 months</option>
          <option value="0-permanent">Permanent</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeBanModal()">Cancel</button>
      <button class="btn btn-danger" id="btn-confirm-ban">Confirm Ban</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"><div class="toast-inner"><span id="toast-message"></span></div></div>

<script>
(function() {
  'use strict';
  
  const CURRENT_USER_KEY = 'cc_current_user';
  const ADMIN_USERS = ['vanmanh', 'depchai'];
  const API_URL = '/api/auth';
  
  let currentUser = null;
  let allUsers = [];
  let allLogs = [];
  let activeVps = [];
  let selectedUsers = new Set();
  let banTargetUser = null;
  let modalUser = null;
  let logFilterType = 'all';
  let autoRefreshInterval = null;
  
  // =====================
  // INIT
  // =====================
  function checkAdmin() {
    try {
      const saved = localStorage.getItem(CURRENT_USER_KEY);
      if (!saved) { window.location.href = 'login.html'; return false; }
      currentUser = JSON.parse(saved);
      if (!ADMIN_USERS.includes(currentUser.username?.toLowerCase())) {
        alert('Access denied!');
        window.location.href = 'index.html';
        return false;
      }
      return true;
    } catch(e) { window.location.href = 'login.html'; return false; }
  }
  
  if (!checkAdmin()) return;
  
  document.getElementById('admin-name').textContent = currentUser.username;
  document.getElementById('admin-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
  
  const $ = id => document.getElementById(id);
  const $$ = sel => document.querySelectorAll(sel);
  
  // =====================
  // TOAST
  // =====================
  let toastTimer = null;
  function showToast(msg, type = 'info') {
    const toast = $('toast');
    const icons = { success: 'âœ“', error: 'âœ—', info: 'â„¹' };
    toast.classList.remove('toast-info', 'toast-success', 'toast-error', 'hidden');
    toast.classList.add('toast-' + type);
    $('toast-message').innerHTML = `<strong style="margin-right:8px">${icons[type] || 'â„¹'}</strong> ${msg}`;
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.add('hidden'), 4000);
  }
  
  // =====================
  // API
  // =====================
  async function callAPI(data) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return await res.json();
    } catch(e) {
      console.error('API error:', e);
      return { success: false, message: e.message };
    }
  }
  
  // =====================
  // SIDEBAR & TABS
  // =====================
  const sidebar = $('sidebar');
  const overlay = $('overlay');
  $('menu-toggle').onclick = () => sidebar.classList.toggle('active');
  overlay.onclick = () => sidebar.classList.remove('active');
  
  const titles = {
    dashboard: 'Dashboard',
    users: 'User Management',
    vps: 'Active VPS',
    time: 'Time Manager',
    tokens: 'GitHub Tokens',
    logs: 'System Logs',
    health: 'System Health'
  };
  
  window.switchTab = function(tabName) {
    $$('.nav-item').forEach(n => n.classList.remove('active'));
    $$('.tab-content').forEach(t => t.classList.add('hidden'));
    document.querySelector(`.nav-item[data-tab="${tabName}"]`)?.classList.add('active');
    $('tab-' + tabName)?.classList.remove('hidden');
    $('page-title').textContent = titles[tabName] || 'Admin';
    if (window.innerWidth < 1024) sidebar.classList.remove('active');
    
    // Load data for tab
    if (tabName === 'logs') fetchLogs();
    if (tabName === 'vps') fetchActiveVps();
    if (tabName === 'tokens') loadTokens();
    if (tabName === 'health') runHealthCheck();
  };
  
  $$('.nav-item[data-tab]').forEach(btn => {
    btn.onclick = () => switchTab(btn.dataset.tab);
  });
  
  // =====================
  // UTILS
  // =====================
  function formatTime(minutes) {
    if (minutes < 60) return `${minutes}m`;
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return m > 0 ? `${h}h ${m}m` : `${h}h`;
  }
  
  function formatDateTime(str) {
    if (!str) return 'â€”';
    try {
      const d = new Date(str);
      return d.toLocaleString('vi-VN', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    } catch(e) { return str; }
  }
  
  function getActionBadgeClass(type) {
    if (!type) return '';
    const t = type.toLowerCase();
    if (t.includes('login')) return 'login';
    if (t.includes('register')) return 'register';
    if (t.includes('ban') && !t.includes('unban')) return 'ban';
    if (t.includes('unban')) return 'unban';
    if (t.includes('vps') || t.includes('delete')) return 'vps';
    if (t.includes('time')) return 'time';
    return '';
  }
  
  function formatLogDetails(obj) {
    if (!obj || typeof obj !== 'object') return '<div class="detail-empty">â€”</div>';
    const ignore = ['type', 'username', 'ip', 'ipRaw', 'ua', 'at', 'createdAt', '_id', 'target'];
    const entries = Object.entries(obj).filter(([k]) => !ignore.includes(k));
    if (entries.length === 0) return '<div class="detail-empty">â€”</div>';
    let html = '<div class="detail-card">';
    for (const [k, v] of entries) {
      let valStr;
      if (v === null || v === undefined) valStr = '<span style="color:var(--text-muted)">â€”</span>';
      else if (typeof v === 'boolean') valStr = v ? '<span style="color:var(--success)">âœ“</span>' : '<span style="color:var(--error)">âœ—</span>';
      else if (typeof v === 'object') valStr = JSON.stringify(v);
      else valStr = String(v);
      const keyName = k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim();
      html += `<div class="detail-row"><span class="detail-key">${keyName}</span><span class="detail-val">${valStr}</span></div>`;
    }
    return html + '</div>';
  }
  
  // =====================
  // FETCH DATA
  // =====================
  async function fetchAllUsers() {
    const data = await callAPI({ action: 'getAllUsers' });
    if (data.success) {
      allUsers = data.users || [];
      updateStats();
      renderUserTable();
      updateUserDatalist();
      $('user-count-badge').textContent = allUsers.length;
    }
  }
  
  async function fetchLogs() {
    const tbody = $('logs-tbody');
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px"><span class="spinner spinner-dark"></span></td></tr>';
    try {
      const res = await fetch('/api/logs');
      const data = await res.json();
      allLogs = data.success && Array.isArray(data.items) ? data.items : [];
      renderLogs();
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--error)">Error: ${e.message}</td></tr>`;
    }
  }
  
  async function fetchActiveVps() {
    const container = $('vps-list');
    container.innerHTML = '<div style="text-align:center;padding:40px"><span class="spinner spinner-dark"></span></div>';
    try {
      const res = await fetch('/api/active-vps');
      const data = await res.json();
      activeVps = data.success && Array.isArray(data.items) ? data.items : [];
      renderVpsList();
      $('vps-count-badge').textContent = activeVps.length;
      $('stat-vps').textContent = activeVps.length;
    } catch (e) {
      container.innerHTML = `<div class="empty-state"><h3>Error loading VPS</h3><p>${e.message}</p></div>`;
    }
  }
  
  // =====================
  // RENDER
  // =====================
  function updateStats() {
    let totalTime = 0, activeUsers = 0, bannedUsers = 0;
    allUsers.forEach(u => {
      totalTime += u.timeMinutes || 0;
      if (u.timeMinutes > 0 && !u.isBanned) activeUsers++;
      if (u.isBanned) bannedUsers++;
    });
    $('stat-users').textContent = allUsers.length;
    $('stat-time').textContent = formatTime(totalTime);
    $('stat-active').textContent = activeUsers;
    $('stat-banned').textContent = bannedUsers;
  }
  
  function renderUserTable() {
    const tbody = $('users-tbody');
    const search = $('user-search').value.toLowerCase();
    const filter = $('user-filter').value;
    
    let filtered = allUsers.filter(u => {
      const matchSearch = u.username.toLowerCase().includes(search) || (u.registerIP && u.registerIP.includes(search));
      if (!matchSearch) return false;
      if (filter === 'active') return !u.isBanned;
      if (filter === 'banned') return u.isBanned;
      if (filter === 'hastime') return (u.timeMinutes || 0) > 0;
      if (filter === 'notime') return (u.timeMinutes || 0) === 0;
      return true;
    });
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No users found</td></tr>';
      return;
    }
    
    tbody.innerHTML = filtered.map(u => {
      const time = u.timeMinutes || 0;
      const isSelected = selectedUsers.has(u.username);
      let statusBadge = '';
      if (u.isBanned) {
        if (u.banType === 'permanent') statusBadge = '<span class="badge badge-error">Permanent Ban</span>';
        else if (u.banUntil) {
          const remaining = new Date(u.banUntil) - new Date();
          if (remaining > 0) {
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            statusBadge = `<span class="badge badge-warning">${hours > 24 ? Math.ceil(hours/24) + 'd' : hours + 'h'} left</span>`;
          } else statusBadge = '<span class="badge badge-info">Expired</span>';
        } else statusBadge = '<span class="badge badge-error">Banned</span>';
      } else statusBadge = '<span class="badge badge-success">Active</span>';
      
      return `
        <tr class="${isSelected ? 'selected' : ''}">
          <td><div class="checkbox ${isSelected ? 'checked' : ''}" data-user="${u.username}"></div></td>
          <td>
            <div class="user-name" style="cursor:pointer" onclick="openUserModal('${u.username}')">${u.username}</div>
            <div class="user-meta">Last: ${u.lastLoginAt ? formatDateTime(u.lastLoginAt) : 'Never'}</div>
          </td>
          <td><span class="badge ${time > 60 ? 'badge-success' : time > 0 ? 'badge-warning' : 'badge-error'}">${formatTime(time)}</span></td>
          <td><span class="ip-text">${u.registerIP || 'N/A'}</span></td>
          <td>${statusBadge}</td>
          <td style="font-size:0.75rem;color:var(--text-muted)">${formatDateTime(u.createdAt)}</td>
          <td>
            <div style="display:flex;gap:6px">
              ${u.isBanned 
                ? `<button class="btn btn-success btn-xs" onclick="unbanUser('${u.username}')">Unban</button>`
                : `<button class="btn btn-danger btn-xs" onclick="openBanModal('${u.username}')">Ban</button>`
              }
              <button class="btn btn-primary btn-xs" onclick="quickAddTimeUser('${u.username}')">+1h</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    // Checkbox events
    tbody.querySelectorAll('.checkbox').forEach(cb => {
      cb.onclick = () => toggleUserSelection(cb.dataset.user);
    });
  }
  
  function renderLogs() {
    const tbody = $('logs-tbody');
    const search = $('log-search').value.toLowerCase();
    
    let filtered = allLogs.filter(it => {
      if (logFilterType !== 'all') {
        const t = (it.type || '').toLowerCase();
        if (logFilterType === 'login' && !t.includes('login')) return false;
        if (logFilterType === 'register' && !t.includes('register')) return false;
        if (logFilterType === 'vps' && !t.includes('vps')) return false;
        if (logFilterType === 'ban' && !t.includes('ban')) return false;
        if (logFilterType === 'time' && !t.includes('time')) return false;
      }
      if (search) {
        const text = JSON.stringify(it).toLowerCase();
        if (!text.includes(search)) return false;
      }
      return true;
    });
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">No logs found</td></tr>';
      return;
    }
    
    tbody.innerHTML = filtered.slice(0, 200).map(it => {
      const time = formatDateTime(it.at || it.createdAt);
      const user = it.username || it.target || it.githubLogin || 'â€”';
      const action = it.type || '';
      const badgeClass = getActionBadgeClass(action);
      const ip = it.ip || 'â€”';
      return `<tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:0.72rem;color:var(--text-secondary)">${time}</td>
        <td><strong>${user}</strong></td>
        <td><span class="action-badge ${badgeClass}">${action}</span></td>
        <td><span class="ip-text">${ip}</span></td>
        <td>${formatLogDetails(it)}</td>
      </tr>`;
    }).join('');
  }
  
  function renderVpsList() {
    const container = $('vps-list');
    if (activeVps.length === 0) {
      container.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg><h3>No Active VPS</h3><p>No VPS instances are currently running.</p></div>';
      return;
    }
    
    const now = Date.now();
    container.innerHTML = activeVps.map(v => {
      const expiresAt = new Date(v.expiresAt).getTime();
      const createdAt = new Date(v.createdAt).getTime();
      const totalMs = expiresAt - createdAt;
      const elapsedMs = now - createdAt;
      const remainingMs = Math.max(0, expiresAt - now);
      const remainingMin = Math.floor(remainingMs / 60000);
      const progress = Math.min(100, (elapsedMs / totalMs) * 100);
      const isExpired = remainingMs <= 0;
      const isWarning = remainingMin > 0 && remainingMin <= 30;
      
      let timerClass = 'active';
      let progressClass = '';
      if (isExpired) { timerClass = 'expired'; progressClass = 'danger'; }
      else if (isWarning) { timerClass = 'warning'; progressClass = 'warning'; }
      
      return `
        <div class="vps-card ${isExpired ? 'expired' : ''}">
          <div class="vps-header">
            <div class="vps-title">${v.owner}/${v.repo}</div>
            <div class="vps-timer ${timerClass}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              ${isExpired ? 'Expired' : formatTime(remainingMin) + ' left'}
            </div>
          </div>
          <div class="vps-meta">
            <span class="badge badge-info">${v.durationMinutes}m total</span>
            <span class="badge badge-cyan">Token: ${v.tokenId?.slice(0,8) || '?'}...</span>
          </div>
          <div class="progress-bar"><div class="progress-fill ${progressClass}" style="width:${progress}%"></div></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <span style="font-size:0.72rem;color:var(--text-muted)">Created: ${formatDateTime(v.createdAt)}</span>
            <button class="btn btn-danger btn-xs" onclick="deleteVps('${v.owner}','${v.repo}')">Force Delete</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function renderRecentActivity() {
    const container = $('recent-activity');
    const recent = allLogs.slice(0, 10);
    if (recent.length === 0) {
      container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
      return;
    }
    container.innerHTML = recent.map(it => {
      const action = it.type || '';
      const badgeClass = getActionBadgeClass(action);
      const user = it.username || it.target || it.githubLogin || '?';
      const time = formatDateTime(it.at || it.createdAt);
      return `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border-light)">
        <span class="action-badge ${badgeClass}" style="min-width:80px;text-align:center">${action}</span>
        <div style="flex:1">
          <div style="font-weight:600;font-size:0.85rem">${user}</div>
          <div style="font-size:0.72rem;color:var(--text-muted)">${time}</div>
        </div>
      </div>`;
    }).join('');
  }
  
  function updateUserDatalist() {
    const dl = $('user-list');
    dl.innerHTML = allUsers.map(u => `<option value="${u.username}">`).join('');
  }
  
  // =====================
  // SELECTION
  // =====================
  function toggleUserSelection(username) {
    if (selectedUsers.has(username)) selectedUsers.delete(username);
    else selectedUsers.add(username);
    renderUserTable();
    updateSelectionBar();
  }
  
  function updateSelectionBar() {
    const bar = $('selection-bar');
    if (selectedUsers.size > 0) {
      bar.classList.remove('hidden');
      $('selection-count').textContent = selectedUsers.size;
    } else {
      bar.classList.add('hidden');
    }
  }
  
  window.clearSelection = function() {
    selectedUsers.clear();
    renderUserTable();
    updateSelectionBar();
  };
  
  $('select-all-users').onclick = function() {
    const search = $('user-search').value.toLowerCase();
    const filter = $('user-filter').value;
    const filtered = allUsers.filter(u => {
      const matchSearch = u.username.toLowerCase().includes(search) || (u.registerIP && u.registerIP.includes(search));
      if (!matchSearch) return false;
      if (filter === 'active') return !u.isBanned;
      if (filter === 'banned') return u.isBanned;
      if (filter === 'hastime') return (u.timeMinutes || 0) > 0;
      if (filter === 'notime') return (u.timeMinutes || 0) === 0;
      return true;
    });
    
    if (selectedUsers.size === filtered.length) {
      selectedUsers.clear();
    } else {
      filtered.forEach(u => selectedUsers.add(u.username));
    }
    renderUserTable();
    updateSelectionBar();
  };
  
  // =====================
  // BULK ACTIONS
  // =====================
  window.bulkAddTime = async function(minutes) {
    if (selectedUsers.size === 0) { showToast('Select users first', 'error'); return; }
    if (!confirm(`Add ${formatTime(minutes)} to ${selectedUsers.size} users?`)) return;
    
    let success = 0;
    for (const username of selectedUsers) {
      const result = await callAPI({ action: 'updateTime', username, minutes, operation: 'add' });
      if (result.success) success++;
    }
    showToast(`Added time to ${success}/${selectedUsers.size} users`, 'success');
    clearSelection();
    fetchAllUsers();
  };
  
  window.bulkBan = async function() {
    if (selectedUsers.size === 0) { showToast('Select users first', 'error'); return; }
    if (!confirm(`Ban ${selectedUsers.size} users for 7 days?`)) return;
    
    let success = 0;
    for (const username of selectedUsers) {
      const result = await callAPI({ action: 'banUser', targetUsername: username, banDuration: 7, banUnit: 'days' });
      if (result.success) success++;
    }
    showToast(`Banned ${success}/${selectedUsers.size} users`, 'success');
    clearSelection();
    fetchAllUsers();
  };
  
  window.bulkUnban = async function() {
    if (selectedUsers.size === 0) { showToast('Select users first', 'error'); return; }
    if (!confirm(`Unban ${selectedUsers.size} users?`)) return;
    
    let success = 0;
    for (const username of selectedUsers) {
      const result = await callAPI({ action: 'unbanUser', targetUsername: username });
      if (result.success) success++;
    }
    showToast(`Unbanned ${success}/${selectedUsers.size} users`, 'success');
    clearSelection();
    fetchAllUsers();
  };
  
  // =====================
  // USER ACTIONS
  // =====================
  window.openUserModal = function(username) {
    const user = allUsers.find(u => u.username === username);
    if (!user) return;
    modalUser = user;
    $('modal-username').textContent = username;
    
    const content = $('user-detail-content');
    content.innerHTML = `
      <div class="user-detail-item"><div class="label">Username</div><div class="value">${user.username}</div></div>
      <div class="user-detail-item"><div class="label">Time Balance</div><div class="value">${formatTime(user.timeMinutes || 0)}</div></div>
      <div class="user-detail-item"><div class="label">Status</div><div class="value">${user.isBanned ? 'Banned' : 'Active'}</div></div>
      <div class="user-detail-item"><div class="label">Register IP</div><div class="value" style="font-family:'JetBrains Mono',monospace;font-size:0.8rem">${user.registerIP || 'N/A'}</div></div>
      <div class="user-detail-item"><div class="label">Created</div><div class="value">${formatDateTime(user.createdAt)}</div></div>
      <div class="user-detail-item"><div class="label">Last Login</div><div class="value">${formatDateTime(user.lastLoginAt) || 'Never'}</div></div>
      ${user.isBanned ? `<div class="user-detail-item" style="grid-column:span 2"><div class="label">Ban Info</div><div class="value">${user.banType === 'permanent' ? 'Permanent' : 'Until ' + formatDateTime(user.banUntil)}<br><small>${user.banReason || ''}</small></div></div>` : ''}
    `;
    
    $('user-modal').classList.remove('hidden');
  };
  
  $('user-modal-close').onclick = () => $('user-modal').classList.add('hidden');
  $('modal-close-btn').onclick = () => $('user-modal').classList.add('hidden');
  $('user-modal').onclick = e => { if (e.target.classList.contains('modal-backdrop')) $('user-modal').classList.add('hidden'); };
  
  $('modal-add-time').onclick = async () => {
    if (!modalUser) return;
    const result = await callAPI({ action: 'updateTime', username: modalUser.username, minutes: 60, operation: 'add' });
    if (result.success) {
      showToast(`+1h for ${modalUser.username}`, 'success');
      fetchAllUsers();
    } else showToast(result.message, 'error');
  };
  
  $('modal-ban-user').onclick = () => {
    if (!modalUser) return;
    $('user-modal').classList.add('hidden');
    openBanModal(modalUser.username);
  };
  
  window.openBanModal = function(username) {
    banTargetUser = username;
    $('ban-username').textContent = username;
    $('ban-modal').classList.remove('hidden');
  };
  
  window.closeBanModal = function() {
    $('ban-modal').classList.add('hidden');
    banTargetUser = null;
  };
  
  $('ban-modal-close').onclick = closeBanModal;
  $('ban-modal').onclick = e => { if (e.target.classList.contains('modal-backdrop')) closeBanModal(); };
  
  $('btn-confirm-ban').onclick = async () => {
    if (!banTargetUser) return;
    const [duration, unit] = $('ban-duration').value.split('-');
    const btn = $('btn-confirm-ban');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    const result = await callAPI({ action: 'banUser', targetUsername: banTargetUser, banDuration: parseInt(duration), banUnit: unit });
    btn.disabled = false;
    btn.textContent = 'Confirm Ban';
    
    if (result.success) {
      showToast(`Banned ${banTargetUser}`, 'success');
      closeBanModal();
      fetchAllUsers();
    } else showToast(result.message, 'error');
  };
  
  window.unbanUser = async function(username) {
    if (!confirm(`Unban ${username}?`)) return;
    const result = await callAPI({ action: 'unbanUser', targetUsername: username });
    if (result.success) {
      showToast(`Unbanned ${username}`, 'success');
      fetchAllUsers();
    } else showToast(result.message, 'error');
  };
  
  window.quickAddTimeUser = async function(username) {
    const result = await callAPI({ action: 'updateTime', username, minutes: 60, operation: 'add' });
    if (result.success) {
      showToast(`+1h for ${username}`, 'success');
      fetchAllUsers();
    } else showToast(result.message, 'error');
  };
  
  // =====================
  // TIME MANAGEMENT
  // =====================
  window.quickTimePreset = function(minutes) {
    $('time-minutes').value = minutes;
    $('time-operation').value = 'add';
  };
  
  $('btn-apply-time').onclick = async () => {
    const username = $('time-username').value.trim();
    const minutes = parseInt($('time-minutes').value) || 0;
    const operation = $('time-operation').value;
    
    if (!username) { showToast('Enter username', 'error'); return; }
    if (minutes < 1) { showToast('Invalid minutes', 'error'); return; }
    
    const btn = $('btn-apply-time');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    const result = await callAPI({ action: 'updateTime', username, minutes, operation });
    btn.disabled = false;
    btn.textContent = 'Apply';
    
    if (result.success) {
      const op = { add: 'Added', deduct: 'Deducted', set: 'Set' }[operation];
      showToast(`${op} ${formatTime(minutes)} for ${username}`, 'success');
      $('time-username').value = '';
      fetchAllUsers();
    } else showToast(result.message, 'error');
  };
  
  // =====================
  // VPS MANAGEMENT
  // =====================
  window.deleteVps = async function(owner, repo) {
    if (!confirm(`Delete VPS ${owner}/${repo}?`)) return;
    try {
      const res = await fetch('/api/delete-vps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ owner, repo })
      });
      const data = await res.json();
      if (data.success) {
        showToast('VPS deleted', 'success');
        fetchActiveVps();
      } else showToast(data.message, 'error');
    } catch (e) { showToast(e.message, 'error'); }
  };
  
  $('btn-cleanup-expired').onclick = async () => {
    if (!confirm('Cleanup all expired VPS?')) return;
    try {
      const res = await fetch('/api/cron');
      const data = await res.json();
      showToast(`Cleanup done: ${data.vpsCleanup?.deleted || 0} deleted`, 'success');
      fetchActiveVps();
    } catch (e) { showToast(e.message, 'error'); }
  };
  
  // =====================
  // TOKENS
  // =====================
  async function loadTokens() {
    const container = $('token-list');
    container.innerHTML = '<div style="text-align:center;padding:20px"><span class="spinner spinner-dark"></span></div>';
    try {
      const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'list' }) });
      const d = await res.json();
      if (!d.success || !d.items?.length) {
        container.innerHTML = '<div class="empty-state"><h3>No Tokens</h3><p>Add a GitHub PAT to enable VPS creation.</p></div>';
        return;
      }
      container.innerHTML = d.items.map(t => {
        const statusBadge = t.status === 'live' ? '<span class="badge badge-success">Live</span>' : '<span class="badge badge-error">Dead</span>';
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg-card);border-radius:var(--radius-md);margin-bottom:10px;border:1px solid var(--border-light)">
          <div>
            <div style="font-weight:700">${t.owner || 'unknown'}</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
              <code style="font-size:0.75rem;background:var(--bg-base);padding:3px 8px;border-radius:4px">${t.masked}</code>
              ${statusBadge}
            </div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-secondary btn-xs" onclick="checkToken('${t.id}')">Check</button>
            <button class="btn btn-danger btn-xs" onclick="deleteToken('${t.id}')">Delete</button>
          </div>
        </div>`;
      }).join('');
    } catch (e) { container.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`; }
  }
  
  $('btn-add-token').onclick = async () => {
    const val = $('new-token-input').value.trim();
    if (!val) { showToast('Enter token', 'error'); return; }
    const btn = $('btn-add-token');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Checking...';
    try {
      const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'add', token: val }) });
      const d = await res.json();
      if (d.success) {
        showToast('Token added', 'success');
        $('new-token-input').value = '';
      } else showToast(d.message, 'error');
    } catch (e) { showToast(e.message, 'error'); }
    btn.disabled = false;
    btn.textContent = 'Add & Verify';
    loadTokens();
  };
  
  window.checkToken = async function(id) {
    const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'check', id }) });
    const d = await res.json();
    showToast(d.success ? 'Token OK' : 'Token failed', d.success ? 'success' : 'error');
    loadTokens();
  };
  
  window.deleteToken = async function(id) {
    if (!confirm('Delete this token?')) return;
    await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'delete', id }) });
    showToast('Token deleted', 'success');
    loadTokens();
  };
  
  $('btn-refresh-tokens').onclick = loadTokens;
  
  // =====================
  // LOGS
  // =====================
  $$('.log-filter').forEach(btn => {
    btn.onclick = () => {
      $$('.log-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      logFilterType = btn.dataset.type;
      renderLogs();
    };
  });
  
  $('log-search').oninput = renderLogs;
  $('btn-refresh-logs').onclick = fetchLogs;
  
  // =====================
  // HEALTH
  // =====================
  async function runHealthCheck() {
    const container = $('health-results');
    container.innerHTML = '<div style="text-align:center;padding:40px"><span class="spinner spinner-dark"></span> Running checks...</div>';
    
    const checks = [];
    
    // Check API
    try {
      const start = Date.now();
      const res = await callAPI({ action: 'getAllUsers' });
      const latency = Date.now() - start;
      checks.push({ name: 'Auth API', status: res.success ? 'ok' : 'error', detail: `${latency}ms` });
    } catch (e) { checks.push({ name: 'Auth API', status: 'error', detail: e.message }); }
    
    // Check Tokens
    try {
      const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'list' }) });
      const d = await res.json();
      const liveCount = d.items?.filter(t => t.status === 'live').length || 0;
      checks.push({ name: 'GitHub Tokens', status: liveCount > 0 ? 'ok' : 'warning', detail: `${liveCount} live` });
    } catch (e) { checks.push({ name: 'GitHub Tokens', status: 'error', detail: e.message }); }
    
    // Check Logs API
    try {
      const res = await fetch('/api/logs');
      const d = await res.json();
      checks.push({ name: 'Logs API', status: d.success ? 'ok' : 'error', detail: `${d.items?.length || 0} entries` });
    } catch (e) { checks.push({ name: 'Logs API', status: 'error', detail: e.message }); }
    
    container.innerHTML = checks.map(c => {
      const icon = c.status === 'ok' ? 'âœ“' : c.status === 'warning' ? 'âš ' : 'âœ—';
      const color = c.status === 'ok' ? 'var(--success)' : c.status === 'warning' ? 'var(--warning)' : 'var(--error)';
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg-card);border-radius:var(--radius-md);margin-bottom:10px;border-left:4px solid ${color}">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:1.2rem;color:${color}">${icon}</span>
          <span style="font-weight:700">${c.name}</span>
        </div>
        <span style="font-size:0.85rem;color:var(--text-muted)">${c.detail}</span>
      </div>`;
    }).join('');
  }
  
  $('btn-run-health').onclick = runHealthCheck;
  
  $('btn-trigger-cron').onclick = async () => {
    const btn = $('btn-trigger-cron');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Running...';
    try {
      const res = await fetch('/api/cron');
      const d = await res.json();
      $('cron-result').innerHTML = `<div style="background:var(--bg-card);border-radius:var(--radius-md);padding:16px;font-family:'JetBrains Mono',monospace;font-size:0.8rem;max-height:300px;overflow:auto"><pre>${JSON.stringify(d, null, 2)}</pre></div>`;
      showToast('Cron completed', 'success');
    } catch (e) {
      $('cron-result').innerHTML = `<div style="color:var(--error)">Error: ${e.message}</div>`;
    }
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Trigger Cron Job';
  };
  
  // =====================
  // EXPORT
  // =====================
  $('btn-export-users').onclick = () => {
    const csv = ['Username,Time(min),Status,RegisterIP,Created'];
    allUsers.forEach(u => {
      csv.push(`${u.username},${u.timeMinutes||0},${u.isBanned?'Banned':'Active'},${u.registerIP||''},${u.createdAt||''}`);
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `users_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Exported!', 'success');
  };
  
  // =====================
  // REFRESH
  // =====================
  async function refreshAll() {
    await Promise.all([fetchAllUsers(), fetchLogs(), fetchActiveVps()]);
    renderRecentActivity();
  }
  
  $('btn-refresh-all').onclick = refreshAll;
  $('btn-refresh-users').onclick = fetchAllUsers;
  $('btn-refresh-vps').onclick = fetchActiveVps;
  $('user-search').oninput = renderUserTable;
  $('user-filter').onchange = renderUserTable;
  
  // Auto refresh toggle
  $('refresh-indicator').onclick = function() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
      this.classList.remove('active');
      showToast('Auto-refresh disabled', 'info');
    } else {
      autoRefreshInterval = setInterval(refreshAll, 30000);
      this.classList.add('active');
      showToast('Auto-refresh: every 30s', 'info');
    }
  };
  
  // =====================
  // INIT
  // =====================
  refreshAll();
})();
</script>
</body>
</html>
