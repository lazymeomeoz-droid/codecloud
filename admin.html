<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Panel - CodeCloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: #020617; --bg-surface: rgba(15,23,42,0.8); --bg-card: rgba(30,41,59,0.6); --bg-elevated: #1e293b;
      --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
      --border-light: rgba(139,92,246,0.12); --border-medium: rgba(139,92,246,0.25);
      --accent: #818cf8; --accent-light: #a5b4fc; --accent-soft: rgba(129,140,248,0.12); --accent-glow: rgba(129,140,248,0.3);
      --success: #34d399; --success-soft: rgba(52,211,153,0.12);
      --error: #f87171; --error-soft: rgba(248,113,113,0.12);
      --warning: #fbbf24; --warning-soft: rgba(251,191,36,0.12);
      --gradient-primary: linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#d946ef 100%);
      --gradient-accent: linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);
      --shadow-md: 0 4px 20px -2px rgba(0,0,0,0.5); --shadow-lg: 0 20px 40px -10px rgba(0,0,0,0.6);
      --shadow-glow: 0 0 50px rgba(129,140,248,0.2);
      --radius-sm: 8px; --radius-md: 14px; --radius-lg: 20px; --radius-xl: 28px;
      --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:var(--bg-base);color:var(--text-primary);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
    .hidden{display:none!important}
    
    .bg-effects{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
    .aurora{position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg at 50% 50%,transparent 0deg,var(--accent-soft) 60deg,transparent 120deg,rgba(34,211,238,0.08) 180deg,transparent 240deg,var(--accent-glow) 300deg,transparent 360deg);animation:auroraRotate 60s linear infinite}
    @keyframes auroraRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    
    .app-container{min-height:100vh;position:relative;z-index:1;padding:20px}
    
    .header{max-width:1400px;margin:0 auto 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:56px;height:56px;border-radius:16px;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-glow);animation:float 4s ease-in-out infinite}
    .logo svg{width:32px;height:32px;color:white}
    .brand-text h1{font-size:1.5rem;font-weight:900;background:var(--gradient-primary);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .brand-text p{font-size:0.8rem;color:var(--text-muted)}
    
    .header-actions{display:flex;gap:12px;align-items:center}
    .admin-badge{padding:8px 16px;border-radius:999px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-weight:700;font-size:0.8rem;display:flex;align-items:center;gap:6px}
    .btn-back{padding:10px 20px;border-radius:999px;border:2px solid var(--border-light);background:var(--bg-card);color:var(--text-primary);font-weight:600;font-size:0.85rem;cursor:pointer;transition:var(--transition);text-decoration:none;display:flex;align-items:center;gap:6px}
    .btn-back:hover{border-color:var(--accent);background:var(--accent-soft);transform:translateY(-2px)}
    
    .container{max-width:1400px;margin:0 auto}
    
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
    @media(max-width:1024px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:600px){.stats-grid{grid-template-columns:1fr}}
    
    .stat-card{background:var(--bg-surface);backdrop-filter:blur(20px);border-radius:var(--radius-lg);padding:20px;border:1px solid var(--border-light);transition:var(--transition);animation:slideUp 0.5s ease-out backwards}
    .stat-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg);border-color:var(--accent)}
    .stat-icon{width:48px;height:48px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin-bottom:12px;font-size:1.5rem}
    .stat-icon.users{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
    .stat-icon.time{background:linear-gradient(135deg,#10b981,#14b8a6)}
    .stat-icon.active{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
    .stat-icon.banned{background:linear-gradient(135deg,#ef4444,#dc2626)}
    .stat-label{font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
    .stat-value{font-size:2rem;font-weight:900;color:var(--text-primary)}
    
    .panel{background:var(--bg-surface);backdrop-filter:blur(30px);border-radius:var(--radius-xl);padding:24px;border:1px solid var(--border-light);box-shadow:var(--shadow-md);margin-bottom:20px;animation:slideUp 0.5s ease-out backwards;position:relative;overflow:hidden}
    .panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-light),transparent);opacity:0.5}
    .panel-header{margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
    .panel-title{font-size:1.1rem;font-weight:800;color:var(--text-primary);display:flex;align-items:center;gap:10px}
    .panel-title::before{content:'';width:4px;height:24px;background:var(--gradient-accent);border-radius:2px}
    .panel-desc{color:var(--text-muted);font-size:0.8rem;margin-top:4px}
    
    .tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .tab{padding:10px 18px;border-radius:999px;border:none;background:var(--bg-card);color:var(--text-muted);font-weight:600;font-size:0.85rem;cursor:pointer;transition:var(--transition)}
    .tab:hover{color:var(--text-primary);background:var(--accent-soft)}
    .tab.active{background:var(--gradient-accent);color:white}
    
    .tab-content{display:none}
    .tab-content.active{display:block;animation:fadeIn 0.3s ease-out}
    
    .form-group{margin-bottom:16px}
    .form-row{display:grid;grid-template-columns:1fr 100px auto;gap:10px;align-items:end;margin-bottom:16px}
    @media(max-width:600px){.form-row{grid-template-columns:1fr}}
    .label{font-size:0.8rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px}
    .input{width:100%;background:var(--bg-card);border-radius:var(--radius-md);border:2px solid var(--border-light);padding:12px 14px;font-size:0.9rem;color:var(--text-primary);transition:var(--transition);font-family:inherit}
    .input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-soft)}
    select.input{cursor:pointer}
    
    .btn{padding:12px 20px;border-radius:999px;border:none;font-weight:700;font-size:0.85rem;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn:hover:not(:disabled){transform:translateY(-2px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .btn-primary{background:var(--gradient-accent);color:white;box-shadow:var(--shadow-md)}
    .btn-success{background:linear-gradient(135deg,var(--success),#14b8a6);color:white}
    .btn-danger{background:linear-gradient(135deg,var(--error),#dc2626);color:white}
    .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:2px solid var(--border-light)}
    .btn-sm{padding:8px 14px;font-size:0.78rem}
    .btn-full{width:100%}
    
    .user-table{width:100%;border-collapse:collapse}
    .user-table th,.user-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border-light);font-size:0.82rem}
    .user-table th{background:var(--bg-card);font-weight:700;color:var(--text-primary);position:sticky;top:0}
    .user-table tr:hover{background:rgba(255,255,255,0.03)}
    .user-table-wrapper{max-height:500px;overflow-y:auto;border-radius:var(--radius-md);border:1px solid var(--border-light)}
    
    .badge{padding:4px 10px;border-radius:999px;font-size:0.72rem;font-weight:700}
    .badge-success{background:var(--success-soft);color:var(--success)}
    .badge-warning{background:var(--warning-soft);color:var(--warning)}
    .badge-error{background:var(--error-soft);color:var(--error)}
    .badge-info{background:var(--accent-soft);color:var(--accent)}
    
    .search-box{display:flex;gap:10px;margin-bottom:16px}
    .search-box .input{flex:1}
    
    .toast{position:fixed;bottom:20px;right:20px;z-index:300;animation:slideUp 0.3s ease-out}
    .toast.hidden{display:none}
    .toast-inner{min-width:260px;max-width:400px;padding:14px 20px;border-radius:var(--radius-lg);display:flex;align-items:center;gap:10px;font-size:0.9rem;font-weight:600;box-shadow:var(--shadow-lg)}
    .toast.toast-success .toast-inner{background:linear-gradient(135deg,#16a34a,#15803d);color:white}
    .toast.toast-error .toast-inner{background:linear-gradient(135deg,#dc2626,#b91c1c);color:white}
    .toast.toast-info .toast-inner{background:var(--gradient-accent);color:white}

    /* Improved Toast */
    .toast-inner { background: var(--bg-elevated) !important; color: var(--text-primary) !important; border: 1px solid var(--border-light) !important; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); padding: 16px 20px; }
    .toast.toast-success .toast-inner { border-left: 4px solid var(--success) !important; background: var(--bg-elevated) !important; }
    .toast.toast-error .toast-inner { border-left: 4px solid var(--error) !important; background: var(--bg-elevated) !important; }
    .toast.toast-info .toast-inner { border-left: 4px solid var(--accent) !important; background: var(--bg-elevated) !important; }
    
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.6s linear infinite}
    
    .ip-text{font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:var(--text-muted)}
    
    .modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center}
    .modal.hidden{display:none}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px)}
    .modal-dialog{position:relative;z-index:1;width:100%;max-width:450px;margin:16px;background:var(--bg-elevated);border-radius:var(--radius-xl);padding:24px;border:1px solid var(--border-light);box-shadow:var(--shadow-lg)}
    .modal-title{font-size:1.1rem;font-weight:800;margin-bottom:16px}
    .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;border:none;background:var(--bg-card);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:var(--error-soft);color:var(--error)}
    
    .settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media(max-width:600px){.settings-grid{grid-template-columns:1fr}}
    .setting-item{background:var(--bg-card);border-radius:var(--radius-md);padding:16px;border:1px solid var(--border-light)}
    .setting-item h4{font-size:0.9rem;font-weight:700;margin-bottom:8px}
    .setting-item p{font-size:0.75rem;color:var(--text-muted);margin-bottom:12px}

    /* Log Details Formatter */
    .detail-grid { display: grid; grid-template-columns: auto 1fr; gap: 4px 12px; font-size: 0.75rem; align-items: baseline; }
    .detail-key { color: var(--accent); font-weight: 600; text-align: right; white-space: nowrap; }
    .detail-val { color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; word-break: break-word; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Custom Select */
    select.input { appearance: none; -webkit-appearance: none; padding-right: 32px; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; }

    /* Admin Panel Polish */
    .stat-card { border-top: 4px solid transparent; }
    .stat-card:hover { border-top-color: var(--accent); }
    .user-table th { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; color: var(--text-muted); }
  </style>
</head>
<body>

<div class="bg-effects"><div class="aurora"></div></div>

<div class="app-container">
  <header class="header">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <div class="brand-text">
        <h1>Admin Panel</h1>
        <p>CodeCloud Management System</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="admin-badge">üõ°Ô∏è <span id="admin-name">Admin</span></div>
      <a href="index.html" class="btn-back">‚Üê Quay l·∫°i Dashboard</a>
    </div>
  </header>
  
  <div class="container">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon users">üë•</div><div class="stat-label">T·ªïng Users</div><div class="stat-value" id="stat-total-users">0</div></div>
      <div class="stat-card"><div class="stat-icon time">‚è±Ô∏è</div><div class="stat-label">T·ªïng Th·ªùi Gian</div><div class="stat-value" id="stat-total-time">0h</div></div>
      <div class="stat-card"><div class="stat-icon active">üü¢</div><div class="stat-label">ƒêang Ho·∫°t ƒê·ªông</div><div class="stat-value" id="stat-active-users">0</div></div>
      <div class="stat-card"><div class="stat-icon banned">üö´</div><div class="stat-label">ƒê√£ B·ªã Ban</div><div class="stat-value" id="stat-banned-users">0</div></div>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="users">üë• Qu·∫£n L√Ω Users</button>
      <button class="tab" data-tab="time">‚è±Ô∏è C·ªông Th·ªùi Gian</button>
      <button class="tab" data-tab="settings">‚öôÔ∏è C√†i ƒê·∫∑t</button>
      <button class="tab" data-tab="logs">üìù Logs</button>
    </div>
    
    <!-- Tab: Users -->
    <div class="tab-content active" id="tab-users">
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2 class="panel-title">üë• Danh S√°ch Users</h2>
            <p class="panel-desc">Qu·∫£n l√Ω t√†i kho·∫£n v√† ban user</p>
          </div>
          <button id="btn-refresh" class="btn btn-secondary btn-sm">üîÑ L√†m m·ªõi</button>
        </div>
        
        <div class="search-box">
          <input type="text" id="user-search" class="input" placeholder="üîç T√¨m ki·∫øm username ho·∫∑c IP..." />
          <select id="user-filter" class="input" style="width:150px">
            <option value="all">T·∫•t c·∫£</option>
            <option value="active">Ho·∫°t ƒë·ªông</option>
            <option value="banned">ƒê√£ ban</option>
          </select>
        </div>
        
        <div class="user-table-wrapper">
          <table class="user-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Th·ªùi Gian</th>
                <th>IP ƒêƒÉng K√Ω</th>
                <th>Tr·∫°ng Th√°i</th>
                <th>Thao T√°c</th>
              </tr>
            </thead>
            <tbody id="user-table-body">
              <tr><td colspan="5" style="text-align:center;padding:40px">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab: Time -->
    <div class="tab-content" id="tab-time">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">‚è±Ô∏è C·ªông/Tr·ª´ Th·ªùi Gian</h2>
        </div>
        
        <div class="form-group">
          <label class="label">T√™n User</label>
          <input type="text" id="time-username" class="input" placeholder="Nh·∫≠p username" />
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="label">S·ªë Ph√∫t</label>
            <input type="number" id="time-minutes" class="input" placeholder="60" min="1" max="6000" value="60" />
          </div>
          <div class="form-group">
            <label class="label">Thao T√°c</label>
            <select id="time-operation" class="input">
              <option value="add">C·ªông</option>
              <option value="deduct">Tr·ª´</option>
              <option value="set">ƒê·∫∑t c·ªë ƒë·ªãnh</option>
            </select>
          </div>
          <button id="btn-apply-time" class="btn btn-primary">√Åp d·ª•ng</button>
        </div>
      </div>
    </div>
    
    <!-- Tab: Settings -->
    <div class="tab-content" id="tab-settings">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">‚öôÔ∏è C√†i ƒê·∫∑t H·ªá Th·ªëng</h2>
        </div>
        
        <div class="settings-grid">
          <div class="setting-item">
            <h4>üîê Token GitHub</h4>
            <p>Qu·∫£n l√Ω GitHub Personal Access Tokens (PAT) d√πng chung ƒë·ªÉ t·∫°o VPS. Th√™m token s·∫Ω ƒë∆∞·ª£c ki·ªÉm tra t·ª± ƒë·ªông tr∆∞·ªõc khi l∆∞u.</p>
            <div style="margin-top:12px">
              <label class="label">Add Token (PAT)</label>
              <input type="password" id="admin-token-input" class="input" placeholder="ghp_xxxxxxxxxxxx" />
              <div style="display:flex;gap:8px;margin-top:8px;"><button id="btn-add-token" class="btn btn-primary">Th√™m v√† Ki·ªÉm tra</button><button id="btn-refresh-tokens" class="btn btn-secondary">L√†m m·ªõi danh s√°ch</button></div>
            </div>
            <div style="margin-top:14px">
              <h4 style="margin-bottom:8px">Saved Tokens</h4>
              <div id="token-list" style="max-height:260px;overflow:auto;border:1px solid var(--border-light);border-radius:8px;padding:8px;background:var(--bg-card)">ƒêang t·∫£i...</div>
            </div>
          </div>
      </div>
    </div>
    
    <!-- Tab: Logs -->
    <div class="tab-content" id="tab-logs">
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2 class="panel-title">üìù H·ªá Th·ªëng Logs</h2>
            <p class="panel-desc">Nh·∫≠t k√Ω s·ª± ki·ªán (ƒëƒÉng nh·∫≠p, ƒëƒÉng k√Ω, thay ƒë·ªïi th·ªùi gian, ban/unban)</p>
          </div>
          <button id="btn-refresh-logs" class="btn btn-secondary btn-sm">üîÑ L√†m m·ªõi</button>
        </div>

        <div class="user-table-wrapper">
          <table class="user-table">
            <thead>
                  <tr>
                    <th>Th·ªùi Gian</th>
                    <th>User</th>
                    <th>H√†nh ƒê·ªông</th>
                    <th>IP</th>
                    <th>IP Raw</th>
                    <th>User-Agent</th>
                    <th>Chi Ti·∫øt</th>
                  </tr>
            </thead>
            <tbody id="logs-table-body">
              <tr><td colspan="5" style="text-align:center;padding:40px">ƒêang t·∫£i...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ban Modal -->
<div id="ban-modal" class="modal hidden">
  <div class="modal-backdrop"></div>
  <div class="modal-dialog">
    <button class="modal-close" id="ban-modal-close">&times;</button>
    <h3 class="modal-title">üö´ Ban User: <span id="ban-username"></span></h3>
    
    <div class="form-group">
      <label class="label">Th·ªùi gian ban</label>
      <select id="ban-duration" class="input">
        <option value="1-hours">1 gi·ªù</option>
        <option value="6-hours">6 gi·ªù</option>
        <option value="12-hours">12 gi·ªù</option>
        <option value="24-hours">24 gi·ªù</option>
        <option value="1-days">1 ng√†y</option>
        <option value="3-days">3 ng√†y</option>
        <option value="7-days">7 ng√†y</option>
        <option value="14-days">14 ng√†y</option>
        <option value="30-days">30 ng√†y</option>
        <option value="1-months">1 th√°ng</option>
        <option value="3-months">3 th√°ng</option>
        <option value="6-months">6 th√°ng</option>
        <option value="12-months">12 th√°ng</option>
        <option value="0-permanent">Vƒ©nh vi·ªÖn</option>
      </select>
    </div>
    
    <div style="display:flex;gap:10px;margin-top:20px">
      <button id="btn-confirm-ban" class="btn btn-danger btn-full">üö´ X√°c nh·∫≠n Ban</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"><div class="toast-inner"><span id="toast-message"></span></div></div>

<script>
(function() {
  'use strict';
  
  const CURRENT_USER_KEY = 'cc_current_user';
  const ADMIN_USERS = ['vanmanh', 'depchai'];
  const API_URL = '/api/auth';
  
  let currentUser = null;
  let allUsers = [];
  let banTargetUser = null;
  
  function checkAdmin() {
    try {
      const saved = localStorage.getItem(CURRENT_USER_KEY);
      if (!saved) { window.location.href = 'login.html'; return false; }
      currentUser = JSON.parse(saved);
      if (!ADMIN_USERS.includes(currentUser.username?.toLowerCase())) {
        alert('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!');
        window.location.href = 'index.html';
        return false;
      }
      return true;
    } catch(e) { window.location.href = 'login.html'; return false; }
  }
  
  if (!checkAdmin()) return;
  
  document.getElementById('admin-name').textContent = currentUser.username;
  
  const $ = id => document.getElementById(id);
  const $$ = sel => document.querySelectorAll(sel);
  
  let toastTimer = null;
  function showToast(msg, type = 'info') {
    const toast = $('toast');
    toast.classList.remove('toast-info', 'toast-success', 'toast-error', 'hidden');
    toast.classList.add('toast-' + type);
    $('toast-message').textContent = (type === 'success' ? '‚úÖ ' : type === 'error' ? '‚ùå ' : '‚ÑπÔ∏è ') + msg;
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.add('hidden'), 3500);
  }
  
  function formatTime(minutes) {
    if (minutes < 60) return `${minutes}m`;
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return m > 0 ? `${h}h ${m}m` : `${h}h`;
  }
  
  async function callAPI(data) {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return await res.json();
    } catch(e) {
      console.error('API error:', e);
      return { success: false, message: e.message };
    }
  }
  
  function formatLogDetails(obj) {
    if (!obj || typeof obj !== 'object') return String(obj);
    
    // Filter out keys that are already columns
    const ignore = ['type', 'username', 'ip', 'ipRaw', 'ua', 'at', 'createdAt', '_id', 'githubLogin', 'target'];
    let html = '<div class="detail-grid">';
    let hasContent = false;
    
    for (const [k, v] of Object.entries(obj)) {
      if (ignore.includes(k)) continue;
      let valStr = typeof v === 'object' ? JSON.stringify(v) : String(v);
      html += `<div class="detail-key">${k}:</div><div class="detail-val">${valStr}</div>`;
      hasContent = true;
    }
    html += '</div>';
    
    return hasContent ? html : '<span style="color:var(--text-muted);font-style:italic;font-size:0.75rem">No extra details</span>';
  }

  async function fetchAllUsers() {
    const data = await callAPI({ action: 'getAllUsers' });
    if (data.success) {
      allUsers = data.users || [];
      updateStats();
      renderUserTable();
    }
  }

  async function fetchLogs() {
    try {
      const res = await fetch('/api/logs');
      const data = await res.json();
      const tbody = $('logs-table-body');
      if (!data.success || !Array.isArray(data.items)) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">Kh√¥ng c√≥ logs</td></tr>';
        return;
      }
      if (data.items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">Kh√¥ng c√≥ logs</td></tr>';
        return;
      }
      tbody.innerHTML = data.items.map(it => {
        const time = it.at || it.createdAt || '';
        const user = it.username || it.target || it.githubLogin || '';
        const action = it.type || '';
        const ip = it.ip || '';
        const ipRaw = it.ipRaw || '';
        const ua = it.ua || '';
        const uaShort = ua.length > 80 ? ua.slice(0,80) + '‚Ä¶' : ua;
        return `<tr>
          <td>${time}</td>
          <td><strong>${user}</strong></td>
          <td>${action}</td>
          <td><span class="ip-text">${ip}</span></td>
          <td><span class="ip-text">${ipRaw}</span></td>
          <td style="max-width:260px;word-break:break-word;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${uaShort}</td>
          <td style="max-width:350px;">${formatLogDetails(it)}</td>
        </tr>`;
      }).join('');
    } catch (e) {
      const tbody = $('logs-table-body');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px">L·ªói khi t·∫£i logs</td></tr>';
    }
  }
  
  function updateStats() {
    let totalTime = 0, activeUsers = 0, bannedUsers = 0;
    allUsers.forEach(u => {
      totalTime += u.timeMinutes || 0;
      if (u.timeMinutes > 0 && !u.isBanned) activeUsers++;
      if (u.isBanned) bannedUsers++;
    });
    $('stat-total-users').textContent = allUsers.length;
    $('stat-total-time').textContent = formatTime(totalTime);
    $('stat-active-users').textContent = activeUsers;
    $('stat-banned-users').textContent = bannedUsers;
  }
  
  function renderUserTable() {
    const tbody = $('user-table-body');
    const search = $('user-search').value.toLowerCase();
    const filter = $('user-filter').value;
    
    let filtered = allUsers.filter(u => {
      const matchSearch = u.username.toLowerCase().includes(search) || 
                         (u.registerIP && u.registerIP.includes(search));
      if (!matchSearch) return false;
      if (filter === 'active') return !u.isBanned;
      if (filter === 'banned') return u.isBanned;
      return true;
    });
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px">Kh√¥ng t√¨m th·∫•y user</td></tr>';
      return;
    }
    
    tbody.innerHTML = filtered.map(u => {
      const time = u.timeMinutes || 0;
      let statusBadge = '';
      if (u.isBanned) {
        if (u.banType === 'permanent') {
          statusBadge = '<span class="badge badge-error">üö´ Vƒ©nh vi·ªÖn</span>';
        } else if (u.banUntil) {
          const remaining = new Date(u.banUntil) - new Date();
          if (remaining > 0) {
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            statusBadge = `<span class="badge badge-warning">‚è∞ C√≤n ${hours}h</span>`;
          } else {
            statusBadge = '<span class="badge badge-info">H·∫øt h·∫°n ban</span>';
          }
        } else {
          statusBadge = '<span class="badge badge-error">üö´ ƒê√£ ban</span>';
        }
      } else {
        statusBadge = '<span class="badge badge-success">‚úÖ Ho·∫°t ƒë·ªông</span>';
      }
      
      return `
        <tr>
          <td><strong>${u.username}</strong></td>
          <td><span class="badge ${time > 60 ? 'badge-success' : time > 0 ? 'badge-warning' : 'badge-error'}">${formatTime(time)}</span></td>
          <td><span class="ip-text">${u.registerIP || 'N/A'}</span></td>
          <td>${statusBadge}</td>
          <td>
            ${u.isBanned 
              ? `<button class="btn btn-success btn-sm" onclick="unbanUser('${u.username}')">Unban</button>`
              : `<button class="btn btn-danger btn-sm" onclick="openBanModal('${u.username}')">Ban</button>`
            }
            <button class="btn btn-primary btn-sm" onclick="quickAddTime('${u.username}')">+1h</button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  window.openBanModal = function(username) {
    banTargetUser = username;
    $('ban-username').textContent = username;
    $('ban-modal').classList.remove('hidden');
  };
  
  function closeBanModal() {
    $('ban-modal').classList.add('hidden');
    banTargetUser = null;
  }
  
  $('ban-modal-close').onclick = closeBanModal;
  $('ban-modal').onclick = e => { if (e.target.classList.contains('modal-backdrop')) closeBanModal(); };
  
  $('btn-confirm-ban').onclick = async () => {
    if (!banTargetUser) return;
    
    const durationValue = $('ban-duration').value;
    const [duration, unit] = durationValue.split('-');
    
    const btn = $('btn-confirm-ban');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    const result = await callAPI({
      action: 'banUser',
      targetUsername: banTargetUser,
      banDuration: parseInt(duration),
      banUnit: unit
    });
    
    btn.disabled = false;
    btn.textContent = 'üö´ X√°c nh·∫≠n Ban';
    
    if (result.success) {
      showToast(`ƒê√£ ban ${banTargetUser}`, 'success');
      closeBanModal();
      await fetchAllUsers();
    } else {
      showToast(result.message || 'L·ªói!', 'error');
    }
  };
  
  window.unbanUser = async function(username) {
    if (!confirm(`Unban ${username}?`)) return;
    
    const result = await callAPI({ action: 'unbanUser', targetUsername: username });
    
    if (result.success) {
      showToast(`ƒê√£ unban ${username}`, 'success');
      await fetchAllUsers();
    } else {
      showToast(result.message || 'L·ªói!', 'error');
    }
  };
  
  window.quickAddTime = async function(username) {
    const result = await callAPI({ action: 'updateTime', username, minutes: 60, operation: 'add' });
    if (result.success) {
      showToast(`+1h cho ${username}`, 'success');
      await fetchAllUsers();
    } else {
      showToast(result.message || 'L·ªói!', 'error');
    }
  };
  
  // Tab switching
  $$('.tab').forEach(tab => {
    tab.onclick = () => {
      $$('.tab').forEach(t => t.classList.remove('active'));
      $$('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      $('tab-' + tab.dataset.tab).classList.add('active');
    };
  });
  
  // Search & Filter
  $('user-search').oninput = renderUserTable;
  $('user-filter').onchange = renderUserTable;
  $('btn-refresh').onclick = fetchAllUsers;
  
  // Apply time
  $('btn-apply-time').onclick = async () => {
    const username = $('time-username').value.trim();
    const minutes = parseInt($('time-minutes').value) || 0;
    const operation = $('time-operation').value;
    
    if (!username) { showToast('Nh·∫≠p t√™n user!', 'error'); return; }
    // verify user exists in local list
    const found = allUsers.find(u => (u.username || '').toLowerCase() === username.toLowerCase());
    if (!found) { showToast('User kh√¥ng t·ªìn t·∫°i!', 'error'); return; }
    if (minutes < 1 || minutes > 6000) { showToast('S·ªë ph√∫t t·ª´ 1-6000!', 'error'); return; }
    
    const btn = $('btn-apply-time');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    
    const result = await callAPI({ action: 'updateTime', username, minutes, operation });
    
    btn.disabled = false;
    btn.textContent = '√Åp d·ª•ng';
    
    if (result.success) {
      const opText = { add: 'C·ªông', deduct: 'Tr·ª´', set: 'ƒê·∫∑t' }[operation];
      showToast(`${opText} ${formatTime(minutes)} cho ${username}`, 'success');
      $('time-username').value = '';
      await fetchAllUsers();
    } else {
      showToast(result.message || 'L·ªói!', 'error');
    }
  };
  
  // GitHub Token
  // Token management
  async function loadTokens() {
    try {
      const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'list' }) });
      const d = await res.json();
      const container = $('token-list');
      if (!d.success || !Array.isArray(d.items)) { container.innerHTML = '<div style="padding:12px;color:var(--text-muted)">No tokens</div>'; return; }
      container.innerHTML = d.items.map(t => {
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px dashed var(--border-light)"><div><div style="font-weight:700">${t.owner || 'unknown'}</div><div style="font-size:0.85rem;color:var(--text-muted)">${t.masked || ''} ‚Ä¢ ${t.status || ''}</div></div><div style="display:flex;gap:8px"><button class="btn btn-sm" data-id="${t.id}" data-action="check">Check</button><button class="btn btn-danger btn-sm" data-id="${t.id}" data-action="delete">Delete</button></div></div>`;
      }).join('');
      container.querySelectorAll('button[data-action]').forEach(b => b.onclick = async (e) => {
        const id = b.dataset.id; const action = b.dataset.action;
        b.disabled = true;
        if (action === 'delete') {
          await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'delete', id }) });
        } else if (action === 'check') {
          await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'check', id }) });
        }
        await loadTokens();
      });
    } catch (e) { console.error(e); showToast('Failed loading tokens', 'error'); }
  }

  $('btn-add-token').onclick = async () => {
    const val = $('admin-token-input').value.trim();
    if (!val) { showToast('Nh·∫≠p token!', 'error'); return; }
    const btn = $('btn-add-token'); btn.disabled = true; btn.textContent = 'Checking...';
    try {
      const res = await fetch('/api/tokens', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'add', token: val }) });
      const d = await res.json();
      if (!d.success) { showToast(d.message || 'Check failed', 'error'); }
      else { showToast('Token live and saved', 'success'); $('admin-token-input').value = ''; }
    } catch (e) { showToast('Error adding token', 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Th√™m v√† Ki·ªÉm tra'; await loadTokens(); }
  };

  $('btn-refresh-tokens').onclick = loadTokens;

  // Init
  fetchAllUsers();
  fetchLogs();
  $('btn-refresh-logs').onclick = fetchLogs;
  loadTokens();
})();
</script>
</body>
</html>