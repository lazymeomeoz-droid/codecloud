<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - CodeCloud</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--surface:#1e293b;--card:#334155;--text:#f1f5f9;--muted:#94a3b8;--accent:#818cf8;--success:#34d399;--error:#f87171;--warning:#fbbf24;--border:rgba(148,163,184,0.1)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
    .header h1{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .btn{padding:10px 20px;border-radius:8px;border:none;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:0.85rem;display:inline-flex;align-items:center;gap:6px}
    .btn-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(99,102,241,0.4)}
    .btn-danger{background:var(--error);color:white}
    .btn-success{background:var(--success);color:white}
    .btn-small{padding:6px 12px;font-size:0.75rem}
    .tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .tab{padding:10px 20px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-weight:600;cursor:pointer;transition:all 0.2s}
    .tab:hover{color:var(--text);border-color:var(--accent)}
    .tab.active{background:var(--accent);color:white;border-color:var(--accent)}
    .panel{background:var(--surface);border-radius:12px;padding:20px;border:1px solid var(--border);margin-bottom:20px}
    .panel-title{font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .hidden{display:none!important}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .stat-card{background:var(--card);padding:16px;border-radius:10px}
    .stat-label{font-size:0.75rem;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
    .stat-value{font-size:1.5rem;font-weight:800}
    table{width:100%;border-collapse:collapse;font-size:0.85rem}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
    th{color:var(--muted);font-weight:600;font-size:0.75rem;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.02)}
    .badge{padding:4px 8px;border-radius:999px;font-size:0.7rem;font-weight:700}
    .badge-success{background:rgba(52,211,153,0.2);color:var(--success)}
    .badge-error{background:rgba(248,113,113,0.2);color:var(--error)}
    .badge-warning{background:rgba(251,191,36,0.2);color:var(--warning)}
    .badge-info{background:rgba(129,140,248,0.2);color:var(--accent)}
    .badge-admin{background:linear-gradient(135deg,rgba(99,102,241,0.3),rgba(168,85,247,0.3));color:#c4b5fd}
    .input{width:100%;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem}
    .input:focus{outline:none;border-color:var(--accent)}
    .form-group{margin-bottom:12px}
    .form-group label{display:block;font-size:0.8rem;color:var(--muted);margin-bottom:4px}
    .toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;font-weight:600;z-index:1000;animation:slideUp 0.3s}
    .toast.success{background:var(--success);color:white}
    .toast.error{background:var(--error);color:white}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .log-entry{padding:10px;background:var(--card);border-radius:6px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:0.75rem}
    .log-entry .time{color:var(--muted);margin-right:8px}
    .log-entry .type{font-weight:700;margin-right:8px}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100}
    .modal-content{background:var(--surface);padding:24px;border-radius:12px;max-width:400px;width:90%}
    .modal-title{font-size:1.1rem;font-weight:700;margin-bottom:16px}
    select.input{cursor:pointer}
    .token-item{background:var(--card);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
    .token-info{flex:1;min-width:200px}
    .token-masked{font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:var(--muted)}
    .empty-state{text-align:center;padding:40px;color:var(--muted)}
    .user-row{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--card);border-radius:8px;margin-bottom:8px;flex-wrap:wrap;gap:8px}
    .user-info{flex:1}
    .user-name{font-weight:700}
    .user-meta{font-size:0.75rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Panel</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="admin-name" style="color:var(--muted);font-size:0.85rem"></span>
        <a href="index.html" class="btn btn-primary">Back to App</a>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="users">Users</button>
      <button class="tab" data-tab="tokens">GitHub Tokens</button>
      <button class="tab" data-tab="logs">System Logs</button>
    </div>

    <!-- Users Tab -->
    <div id="tab-users">
      <div class="grid grid-2">
        <div class="stat-card">
          <div class="stat-label">Total Users</div>
          <div class="stat-value" id="total-users">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Banned Users</div>
          <div class="stat-value" id="banned-users">0</div>
        </div>
      </div>

      <div class="panel" style="margin-top:20px">
        <div class="panel-title">Add Time to User</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input type="text" id="time-username" class="input" placeholder="Username" style="flex:1;min-width:150px">
          <input type="number" id="time-minutes" class="input" placeholder="Minutes" style="width:100px" value="60">
          <button class="btn btn-success" onclick="addTimeToUser()">Add Time</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">All Users</div>
        <div id="users-list"></div>
      </div>
    </div>

    <!-- Tokens Tab -->
    <div id="tab-tokens" class="hidden">
      <div class="panel">
        <div class="panel-title">Add GitHub Token</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input type="password" id="new-token" class="input" placeholder="ghp_xxxxxxxxxxxx" style="flex:1">
          <button class="btn btn-primary" onclick="addToken()">Add & Test Token</button>
        </div>
        <p style="font-size:0.75rem;color:var(--muted);margin-top:8px">Token will be tested by creating a test repo and running a workflow.</p>
      </div>

      <div class="panel">
        <div class="panel-title">Token Pool</div>
        <div id="tokens-list"></div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="tab-logs" class="hidden">
      <div class="panel">
        <div class="panel-title">System Logs</div>
        <button class="btn btn-primary btn-small" onclick="loadLogs()" style="margin-bottom:12px">Refresh</button>
        <div id="logs-list" style="max-height:600px;overflow-y:auto"></div>
      </div>
    </div>
  </div>

  <!-- Ban Modal -->
  <div id="ban-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-title">Ban User: <span id="ban-username"></span></div>
      <div class="form-group">
        <label>Duration</label>
        <input type="number" id="ban-duration" class="input" value="1">
      </div>
      <div class="form-group">
        <label>Unit</label>
        <select id="ban-unit" class="input">
          <option value="hours">Hours</option>
          <option value="days">Days</option>
          <option value="months">Months</option>
          <option value="permanent">Permanent</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px">
        <button class="btn" onclick="closeBanModal()" style="background:var(--card)">Cancel</button>
        <button class="btn btn-danger" onclick="confirmBan()">Ban User</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    const CURRENT_USER_KEY = 'cc_current_user';
    const ADMIN_USERS = ['vanmanh', 'depchai'];
    let currentAdmin = null;
    let selectedBanUser = null;

    function checkAdmin() {
      try {
        const saved = localStorage.getItem(CURRENT_USER_KEY);
        if (!saved) { window.location.href = 'login.html'; return false; }
        currentAdmin = JSON.parse(saved);
        if (!ADMIN_USERS.includes(currentAdmin.username?.toLowerCase())) {
          window.location.href = 'index.html';
          return false;
        }
        document.getElementById('admin-name').textContent = currentAdmin.username;
        return true;
      } catch(e) { window.location.href = 'login.html'; return false; }
    }

    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type;
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));
        document.getElementById('tab-' + tab.dataset.tab).classList.remove('hidden');
        if (tab.dataset.tab === 'users') loadUsers();
        if (tab.dataset.tab === 'tokens') loadTokens();
        if (tab.dataset.tab === 'logs') loadLogs();
      };
    });

    // Users
    async function loadUsers() {
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getAllUsers' })
        });
        const data = await res.json();
        
        // Get regular users from API
        let users = data.users || [];
        
        // Add admin accounts to the list
        const adminAccounts = ADMIN_USERS.map(name => ({
          username: name,
          isAdmin: true,
          timeMinutes: 9999,
          createdAt: 'System',
          isBanned: false
        }));
        
        // Combine: admins first, then regular users
        const allUsers = [...adminAccounts, ...users.filter(u => !ADMIN_USERS.includes(u.username?.toLowerCase()))];
        
        const bannedCount = users.filter(u => u.isBanned).length;
        document.getElementById('total-users').textContent = allUsers.length;
        document.getElementById('banned-users').textContent = bannedCount;
        
        const container = document.getElementById('users-list');
        if (allUsers.length === 0) {
          container.innerHTML = '<div class="empty-state">No users found</div>';
          return;
        }
        
        container.innerHTML = allUsers.map(u => {
          const isAdminUser = ADMIN_USERS.includes(u.username?.toLowerCase()) || u.isAdmin;
          const roleLabel = isAdminUser ? '<span class="badge badge-admin">ADMIN</span>' : '<span class="badge badge-info">Member</span>';
          const banStatus = u.isBanned ? '<span class="badge badge-error">BANNED</span>' : '';
          const timeDisplay = isAdminUser ? '∞' : `${u.timeMinutes || 0} min`;
          
          return `
            <div class="user-row">
              <div class="user-info">
                <div class="user-name">${u.username} ${roleLabel} ${banStatus}</div>
                <div class="user-meta">Time: ${timeDisplay} | Created: ${u.createdAt || 'N/A'}${u.registerIP ? ' | IP: ' + u.registerIP : ''}</div>
              </div>
              <div class="actions">
                <button class="btn btn-success btn-small" onclick="quickAddTime('${u.username}')">+60m</button>
                ${!isAdminUser ? (u.isBanned 
                  ? `<button class="btn btn-small" style="background:var(--warning)" onclick="unbanUser('${u.username}')">Unban</button>`
                  : `<button class="btn btn-danger btn-small" onclick="openBanModal('${u.username}')">Ban</button>`
                ) : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch(e) {
        console.error(e);
        showToast('Failed to load users', 'error');
      }
    }

    async function quickAddTime(username) {
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'updateTime', username, minutes: 60, operation: 'add' })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Added 60 minutes to ${username}`);
          loadUsers();
        } else {
          showToast(data.message || 'Failed', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function addTimeToUser() {
      const username = document.getElementById('time-username').value.trim();
      const minutes = parseInt(document.getElementById('time-minutes').value) || 60;
      if (!username) { showToast('Enter username', 'error'); return; }
      
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'updateTime', username, minutes, operation: 'add' })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Added ${minutes} minutes to ${username}`);
          document.getElementById('time-username').value = '';
          loadUsers();
        } else {
          showToast(data.message || 'Failed', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    function openBanModal(username) {
      selectedBanUser = username;
      document.getElementById('ban-username').textContent = username;
      document.getElementById('ban-modal').classList.remove('hidden');
    }

    function closeBanModal() {
      document.getElementById('ban-modal').classList.add('hidden');
      selectedBanUser = null;
    }

    async function confirmBan() {
      if (!selectedBanUser) return;
      const duration = parseInt(document.getElementById('ban-duration').value) || 1;
      const unit = document.getElementById('ban-unit').value;
      
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'banUser', targetUsername: selectedBanUser, banDuration: duration, banUnit: unit })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Banned ${selectedBanUser}`);
          closeBanModal();
          loadUsers();
        } else {
          showToast(data.message || 'Failed', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function unbanUser(username) {
      try {
        const res = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'unbanUser', targetUsername: username })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`Unbanned ${username}`);
          loadUsers();
        } else {
          showToast(data.message || 'Failed', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    // Tokens
    async function loadTokens() {
      try {
        const res = await fetch('/api/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'list' })
        });
        const data = await res.json();
        const tokens = data.items || [];
        
        const container = document.getElementById('tokens-list');
        if (tokens.length === 0) {
          container.innerHTML = '<div class="empty-state">No tokens. Add one above.</div>';
          return;
        }
        
        container.innerHTML = tokens.map(t => `
          <div class="token-item">
            <div class="token-info">
              <div><strong>${t.owner || 'Unknown'}</strong> <span class="badge ${t.status === 'live' ? 'badge-success' : 'badge-error'}">${t.status?.toUpperCase() || 'UNKNOWN'}</span></div>
              <div class="token-masked">${t.masked}</div>
              ${t.lastChecked ? `<div style="font-size:0.7rem;color:var(--muted)">Last check: ${new Date(t.lastChecked).toLocaleString()}</div>` : ''}
            </div>
            <div class="actions">
              <button class="btn btn-small" style="background:var(--accent)" onclick="checkToken('${t.id}')">Check</button>
              <button class="btn btn-danger btn-small" onclick="deleteToken('${t.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch(e) {
        showToast('Failed to load tokens', 'error');
      }
    }

    async function addToken() {
      const token = document.getElementById('new-token').value.trim();
      if (!token) { showToast('Enter token', 'error'); return; }
      
      showToast('Testing token... (this may take 30-60s)', 'success');
      
      try {
        const res = await fetch('/api/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add', token })
        });
        const data = await res.json();
        if (data.success) {
          showToast(data.message + (data.owner ? ` (${data.owner})` : ''));
          document.getElementById('new-token').value = '';
          loadTokens();
        } else {
          showToast(data.message || 'Token is dead', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function checkToken(id) {
      showToast('Checking token...');
      try {
        const res = await fetch('/api/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'check', id })
        });
        const data = await res.json();
        showToast(data.message || (data.live ? 'Token is LIVE' : 'Token is DEAD'), data.live ? 'success' : 'error');
        loadTokens();
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function deleteToken(id) {
      if (!confirm('Delete this token?')) return;
      try {
        const res = await fetch('/api/tokens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', id })
        });
        const data = await res.json();
        if (data.success) {
          showToast('Token deleted');
          loadTokens();
        } else {
          showToast(data.message || 'Failed', 'error');
        }
      } catch(e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    // Logs
    async function loadLogs() {
      try {
        const res = await fetch('/api/logs');
        const data = await res.json();
        const logs = data.items || [];
        
        const container = document.getElementById('logs-list');
        if (logs.length === 0) {
          container.innerHTML = '<div class="empty-state">No logs yet</div>';
          return;
        }
        
        const typeColors = {
          'login': 'badge-info',
          'admin_login': 'badge-admin',
          'register': 'badge-success',
          'ban': 'badge-error',
          'unban': 'badge-warning',
          'updateTime': 'badge-success',
          'vps_created': 'badge-info',
          'vps_deleted': 'badge-warning'
        };
        
        container.innerHTML = logs.slice(0, 100).map(log => {
          const time = log.at ? new Date(log.at).toLocaleString() : (log.createdAt ? new Date(log.createdAt).toLocaleString() : 'N/A');
          const typeClass = typeColors[log.type] || 'badge-info';
          let details = '';
          
          if (log.type === 'login' || log.type === 'admin_login' || log.type === 'register') {
            details = `User: ${log.username} | IP: ${log.ip || 'N/A'}`;
          } else if (log.type === 'updateTime') {
            details = `User: ${log.username} | ${log.operation}: ${log.minutes}m | ${log.previousMinutes}m → ${log.newMinutes}m`;
          } else if (log.type === 'ban' || log.type === 'unban') {
            details = `Target: ${log.target}`;
          } else if (log.type === 'vps_created') {
            details = `Repo: ${log.repo} | User: ${log.username || log.githubLogin} | ${log.durationMinutes}m`;
          } else if (log.type === 'vps_deleted') {
            details = `Repo: ${log.owner}/${log.repo}`;
          } else {
            details = JSON.stringify(log).slice(0, 100);
          }
          
          return `
            <div class="log-entry">
              <span class="time">${time}</span>
              <span class="badge ${typeClass}">${log.type}</span>
              <span>${details}</span>
            </div>
          `;
        }).join('');
      } catch(e) {
        showToast('Failed to load logs', 'error');
      }
    }

    // Init
    if (checkAdmin()) {
      loadUsers();
    }
  </script>
</body>
</html>
