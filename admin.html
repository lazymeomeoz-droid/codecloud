<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B0E14">
  <title>Admin - CodeCloud</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Cosmic Glass Theme - Dark Mode Only for Admin */
      --bg-base: #02040a;
      --glass-surface: rgba(18, 24, 38, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --text-main: #f8fafc; --text-sec: #94a3b8;
      --primary: #818cf8; --primary-glow: rgba(129, 140, 248, 0.3);
      --accent: #c084fc; --error: #f87171; --success: #4ade80;
      --radius: 16px;
      --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
      --font-sans: 'Inter', sans-serif;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: var(--font-sans); background: var(--bg-base); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

    .bg-aurora { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% -20%, #1e1b4b, #020617 80%); }
    .aurora-glow { position: absolute; width: 100vw; height: 100vh; background: radial-gradient(circle at 80% 20%, rgba(129, 140, 248, 0.15), transparent 50%); filter: blur(60px); animation: pulse 10s infinite alternate; }
    @keyframes pulse { 0% { opacity: 0.5; } 100% { opacity: 0.8; transform: scale(1.05); } }

    /* Layout */
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    @media(max-width: 1024px) { .layout { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar {
      background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      padding: 24px; display: flex; flex-direction: column; gap: 8px;
      position: sticky; top: 0; height: 100vh;
    }
    @media(max-width: 1024px) { .sidebar { display: none; } }

    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; padding: 0 12px; }
    .brand-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 8px; }
    .brand h1 { font-size: 1.2rem; font-weight: 800; letter-spacing: -0.5px; }

    .nav-btn {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-radius: 12px; color: var(--text-sec); font-weight: 600; cursor: pointer;
      transition: 0.2s; background: transparent; border: none; font-family: inherit;
    }
    .nav-btn:hover { background: var(--glass-highlight); color: var(--text-main); }
    .nav-btn.active { background: rgba(129, 140, 248, 0.1); color: var(--primary); border: 1px solid rgba(129, 140, 248, 0.2); }
    .nav-btn svg { width: 20px; height: 20px; }

    /* Main */
    .main { padding: 32px; max-width: 1400px; width: 100%; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .title { font-size: 1.8rem; font-weight: 800; }
    .badge-admin { padding: 6px 12px; background: rgba(129, 140, 248, 0.15); color: var(--primary); border-radius: 20px; font-size: 0.8rem; font-weight: 700; border: 1px solid rgba(129, 140, 248, 0.3); }

    /* Cards */
    .card {
      background: var(--glass-surface); backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow);
    }
    .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 1.1rem; font-weight: 700; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .stat { background: var(--glass-surface); border: 1px solid var(--glass-border); padding: 20px; border-radius: var(--radius); display: flex; align-items: center; gap: 16px; }
    .stat-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); }
    .stat-val { font-size: 1.5rem; font-weight: 800; }
    .stat-label { color: var(--text-sec); font-size: 0.85rem; }

    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; padding: 16px; color: var(--text-sec); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); }
    td { padding: 16px; border-bottom: 1px solid var(--glass-border); color: var(--text-main); font-size: 0.9rem; }
    tr:hover td { background: var(--glass-highlight); }

    /* Elements */
    .btn {
      padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 0.85rem;
      transition: 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
    .btn-danger { background: rgba(248, 113, 113, 0.15); color: var(--error); border: 1px solid rgba(248, 113, 113, 0.3); }
    .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; background: var(--glass-highlight); color: var(--text-sec); }
    .btn-icon:hover { color: var(--text-main); background: rgba(255,255,255,0.1); }

    .input {
      background: var(--glass-highlight); border: 1px solid var(--glass-border); color: white;
      padding: 10px 14px; border-radius: 10px; outline: none; transition: 0.2s;
    }
    .input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }

    .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .bg-green { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
    .bg-red { background: rgba(248, 113, 113, 0.15); color: #f87171; }
    .bg-blue { background: rgba(129, 140, 248, 0.15); color: #818cf8; }

    .hidden { display: none; }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 24px; background: #1e293b; border: 1px solid var(--glass-border); border-radius: 12px; box-shadow: var(--shadow); transform: translateY(100px); transition: 0.3s; opacity: 0; }
    .toast.active { transform: translateY(0); opacity: 1; }
  </style>
</head>
<body>
  <div class="bg-aurora"><div class="aurora-glow"></div></div>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-icon"></div>
        <h1>Admin Panel</h1>
      </div>
      <button class="nav-btn active" data-tab="vps">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        Running VPS
      </button>
      <button class="nav-btn" data-tab="users">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Users
      </button>
      <button class="nav-btn" data-tab="logs">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        System Logs
      </button>
      <button class="nav-btn" data-tab="tokens">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><path d="M7 10h10"/></svg>
        Tokens
      </button>
      <a href="index.html" class="nav-btn" style="margin-top:auto">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/></svg>
        Back to App
      </a>
    </aside>

    <!-- Content -->
    <main class="main">
      <header class="header">
        <h2 class="title" id="page-title">Dashboard</h2>
        <div class="badge-admin" id="admin-name">Admin</div>
      </header>

      <!-- VPS View -->
      <div id="tab-vps" class="view">
        <div class="stats-row">
          <div class="stat">
            <div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><activity/></svg></div>
            <div><div class="stat-val" id="total-vps">0</div><div class="stat-label">Active Instances</div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">Running Instances</div>
            <button class="btn-icon" onclick="loadVPS()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
          </div>
          <div class="table-wrap">
            <table id="vps-table">
              <thead><tr><th>User</th><th>Repo</th><th>Plan</th><th>Started</th><th>Expires</th><th>Action</th></tr></thead>
              <tbody id="vps-list"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Users View -->
      <div id="tab-users" class="view hidden">
        <div class="card">
          <div class="card-head"><div class="card-title">Quick Add Time</div></div>
          <div style="display:flex;gap:12px">
            <input id="time-user" class="input" placeholder="Username" style="width:200px">
            <input id="time-amt" type="number" class="input" value="60" style="width:100px">
            <button class="btn btn-primary" onclick="addTime()">Add Time</button>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">User Management</div>
            <button class="btn-icon" onclick="loadUsers()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
          </div>
          <div class="table-wrap">
            <table id="users-table">
              <thead><tr><th>User</th><th>Role</th><th>Balance</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
              <tbody id="users-list"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Logs View -->
      <div id="tab-logs" class="view hidden">
        <div class="card">
          <div class="card-head">
            <div class="card-title">System Events</div>
            <button class="btn-icon" onclick="loadLogs()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
          </div>
          <div class="table-wrap">
            <table id="logs-table">
              <thead><tr><th>Time</th><th>Type</th><th>Details</th></tr></thead>
              <tbody id="logs-list"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tokens View -->
      <div id="tab-tokens" class="view hidden">
        <div class="card">
          <div class="card-head"><div class="card-title">Add GitHub Token</div></div>
          <div style="display:flex;gap:12px">
            <input id="new-token" type="password" class="input" placeholder="ghp_..." style="flex:1">
            <button class="btn btn-primary" onclick="addToken()">Add Token</button>
          </div>
        </div>
        <div class="card">
          <div class="card-head">
            <div class="card-title">Token Pool</div>
            <button class="btn-icon" onclick="loadTokens()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
          </div>
          <div class="table-wrap">
            <tbody id="tokens-list"></tbody>
          </div>
        </div>
      </div>

    </main>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const showToast = (m) => { const t=$('#toast'); t.textContent=m; t.classList.add('active'); setTimeout(()=>t.classList.remove('active'),3000); };
    
    // Check Admin
    try {
      const u = JSON.parse(localStorage.getItem('cc_current_user'));
      if(!u || !['vanmanh','depchai'].includes(u.username)) location.href='index.html';
      $('#admin-name').textContent = u.username;
    } catch{ location.href='login.html'; }

    // Tabs
    $$('.nav-btn[data-tab]').forEach(b => b.onclick = () => {
      $$('.nav-btn').forEach(n => n.classList.remove('active')); b.classList.add('active');
      $$('.view').forEach(v => v.classList.add('hidden'));
      $(`#tab-${b.dataset.tab}`).classList.remove('hidden');
      $('#page-title').textContent = b.textContent.trim();
      if(b.dataset.tab === 'vps') loadVPS();
      if(b.dataset.tab === 'users') loadUsers();
      if(b.dataset.tab === 'logs') loadLogs();
      if(b.dataset.tab === 'tokens') loadTokens();
    });

    // Functions (Simplified)
    async function loadVPS() {
      const res = await fetch('/api/active-vps');
      const data = await res.json();
      $('#total-vps').textContent = data.items.length;
      const tb = $('#vps-list'); tb.innerHTML='';
      data.items.forEach(v => {
        tb.innerHTML += `<tr><td><b>${v.owner}</b></td><td>${v.repo}</td><td><span class="badge bg-blue">${v.planId||'Std'}</span></td><td>${new Date(v.createdAt).toLocaleTimeString()}</td><td>${Math.max(0,Math.round((new Date(v.expiresAt)-Date.now())/60000))}m</td><td><button class="btn btn-danger" onclick="delVPS('${v.owner}','${v.repo}')">Kill</button></td></tr>`;
      });
    }
    async function delVPS(o,r) { if(confirm('Kill?')) await fetch('/api/delete-vps',{method:'POST',body:JSON.stringify({owner:o,repo:r})}); loadVPS(); }
    
    async function loadUsers() {
      const res = await fetch('/api/auth',{method:'POST',body:JSON.stringify({action:'getAllUsers'})});
      const d = await res.json();
      const tb = $('#users-list'); tb.innerHTML='';
      (d.users||[]).forEach(u => {
        tb.innerHTML += `<tr><td><b>${u.username}</b></td><td>${u.isAdmin?'Admin':'User'}</td><td>${u.timeMinutes}m</td><td>${u.isBanned?'<span class="badge bg-red">BAN</span>':'<span class="badge bg-green">OK</span>'}</td><td>${new Date(u.createdAt).toLocaleDateString()}</td><td><button class="btn btn-primary" onclick="addTime('${u.username}')">+60m</button></td></tr>`;
      });
    }
    async function addTime(u) { 
      const user = u || $('#time-user').value; const m = u ? 60 : $('#time-amt').value;
      await fetch('/api/auth',{method:'POST',body:JSON.stringify({action:'updateTime',username:user,minutes:parseInt(m),operation:'add'})});
      showToast('Added time'); loadUsers();
    }

    async function loadLogs() {
      const res = await fetch('/api/logs'); const d = await res.json();
      $('#logs-list').innerHTML = d.items.map(l => `<tr><td style="font-family:monospace">${new Date(l.at).toLocaleTimeString()}</td><td><span class="badge bg-blue">${l.type}</span></td><td style="color:#94a3b8">${JSON.stringify(l).slice(0,80)}...</td></tr>`).join('');
    }

    // Init
    loadVPS();
  </script>
</body>
</html>