<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0a0f">
  <title>Admin Panel - CodeCloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-base: #06080d;
      --bg-card: rgba(15, 20, 35, 0.8);
      --bg-card-hover: rgba(20, 28, 50, 0.9);
      --bg-input: rgba(25, 35, 60, 0.6);
      --border: rgba(99, 102, 241, 0.15);
      --border-subtle: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --primary: #818cf8;
      --primary-dim: rgba(129, 140, 248, 0.15);
      --accent: #a78bfa;
      --success: #34d399;
      --success-dim: rgba(52, 211, 153, 0.15);
      --error: #f87171;
      --error-dim: rgba(248, 113, 113, 0.15);
      --warning: #fbbf24;
      --warning-dim: rgba(251, 191, 36, 0.15);
      --info: #60a5fa;
      --info-dim: rgba(96, 165, 250, 0.15);
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --sidebar-w: 280px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Aurora Background */
    .bg-aurora {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
      background: linear-gradient(135deg, #06080d 0%, #0c1222 50%, #0a0a1a 100%);
    }
    
    .aurora-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.5;
      animation: float 20s ease-in-out infinite;
    }
    
    .orb-1 {
      width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.3), transparent 70%);
      top: -200px; left: -100px;
    }
    
    .orb-2 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.25), transparent 70%);
      bottom: -150px; right: -100px;
      animation-delay: -10s;
    }
    
    .orb-3 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.2), transparent 70%);
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: -5s;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.05); }
      66% { transform: translate(-20px, 20px) scale(0.95); }
    }

    /* Layout */
    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-subtle);
      padding: 28px 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
        box-shadow: var(--shadow);
      }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 0 12px;
      margin-bottom: 36px;
    }

    .brand-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(129, 140, 248, 0.3);
    }

    .brand-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .brand-text h1 {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .brand-text span {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .nav-section {
      margin-bottom: 8px;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0 16px;
      margin-bottom: 12px;
    }

    .nav-menu {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--primary-dim);
      color: var(--primary);
      border-color: rgba(129, 140, 248, 0.2);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .nav-item .badge {
      margin-left: auto;
      background: var(--primary);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid var(--border-subtle);
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: var(--sidebar-w);
      padding: 32px;
      max-width: 100%;
    }

    @media (max-width: 1024px) {
      .main {
        margin-left: 0;
        padding: 20px;
      }
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-btn {
      display: none;
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 1024px) {
      .menu-btn {
        display: flex;
      }
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .admin-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50px;
    }

    .admin-avatar {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .admin-name {
      font-weight: 700;
      font-size: 0.9rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border);
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .stat-icon.blue { background: var(--info-dim); color: var(--info); }
    .stat-icon.green { background: var(--success-dim); color: var(--success); }
    .stat-icon.purple { background: var(--primary-dim); color: var(--primary); }
    .stat-icon.orange { background: var(--warning-dim); color: var(--warning); }

    .stat-icon svg {
      width: 24px;
      height: 24px;
    }

    .stat-content {
      flex: 1;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 6px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      border-radius: 4px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .card-body {
      padding: 24px;
    }

    .card-body.no-padding {
      padding: 0;
    }

    /* Tables */
    .table-wrap {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th {
      text-align: left;
      padding: 14px 20px;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--border-subtle);
      white-space: nowrap;
    }

    td {
      padding: 16px 20px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    td strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .badge-green { background: var(--success-dim); color: var(--success); }
    .badge-red { background: var(--error-dim); color: var(--error); }
    .badge-blue { background: var(--info-dim); color: var(--info); }
    .badge-purple { background: var(--primary-dim); color: var(--primary); }
    .badge-orange { background: var(--warning-dim); color: var(--warning); }
    .badge-gray { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      box-shadow: 0 4px 14px rgba(129, 140, 248, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(129, 140, 248, 0.4);
    }

    .btn-danger {
      background: var(--error-dim);
      color: var(--error);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.25);
    }

    .btn-success {
      background: var(--success-dim);
      color: var(--success);
      border: 1px solid rgba(52, 211, 153, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-icon {
      width: 38px;
      height: 38px;
      padding: 0;
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--primary);
      border-color: var(--border);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    /* Inputs */
    .input {
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: inherit;
      transition: all 0.2s ease;
      outline: none;
    }

    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.15);
    }

    .input::placeholder {
      color: var(--text-muted);
    }

    /* Form Row */
    .form-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Time remaining bar */
    .time-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    .time-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--warning));
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    /* Views */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      backdrop-filter: blur(20px);
    }

    .toast.active {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    .toast-error {
      border-left: 4px solid var(--error);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Monospace */
    .mono {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        flex-direction: column;
        align-items: stretch;
      }

      .form-row .input {
        width: 100%;
      }
    }

    /* Overlay */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 99;
    }

    .overlay.active {
      display: block;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
  </style>
</head>
<body>

<div class="bg-aurora">
  <div class="aurora-orb orb-1"></div>
  <div class="aurora-orb orb-2"></div>
  <div class="aurora-orb orb-3"></div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <div class="brand-text">
        <h1>Admin Panel</h1>
        <span>CodeCloud VPS</span>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Management</div>
      <nav class="nav-menu">
        <button class="nav-item active" data-tab="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>
          Dashboard
        </button>
        <button class="nav-item" data-tab="vps">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          Running VPS
          <span class="badge" id="vps-count">0</span>
        </button>
        <button class="nav-item" data-tab="users">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Users
        </button>
        <button class="nav-item" data-tab="logs">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          System Logs
        </button>
        <button class="nav-item" data-tab="tokens">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          Tokens
        </button>
      </nav>
    </div>

    <div class="sidebar-footer">
      <a href="index.html" class="nav-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Back to App
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <header class="header">
      <div class="header-left">
        <button class="menu-btn" id="menu-btn" onclick="toggleSidebar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
        <h1 class="page-title" id="page-title">Dashboard</h1>
      </div>
      <div class="admin-badge">
        <div class="admin-avatar" id="admin-avatar">A</div>
        <span class="admin-name" id="admin-name">Admin</span>
      </div>
    </header>

    <!-- Dashboard View -->
    <div id="view-dashboard" class="view active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="stat-vps">0</div>
            <div class="stat-label">Active VPS</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="stat-users">0</div>
            <div class="stat-label">Total Users</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="stat-tokens">0</div>
            <div class="stat-label">Live Tokens</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="stat-logs">0</div>
            <div class="stat-label">Events Today</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Activity</h3>
          <button class="btn-icon" onclick="loadDashboard()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Time</th><th>Type</th><th>User</th><th>Details</th></tr>
              </thead>
              <tbody id="recent-activity"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- VPS View -->
    <div id="view-vps" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Running Instances</h3>
          <div class="card-actions">
            <button class="btn btn-ghost btn-sm" onclick="runCronCleanup()">ðŸ§¹ Cleanup Expired</button>
            <button class="btn-icon" onclick="loadVPS()" title="Refresh">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            </button>
          </div>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Owner</th><th>Repository</th><th>Plan</th><th>Started</th><th>Time Left</th><th>Actions</th></tr>
              </thead>
              <tbody id="vps-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Users View -->
    <div id="view-users" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Quick Add Time</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <input type="text" id="time-username" class="input" placeholder="Username" style="width:200px">
            <input type="number" id="time-minutes" class="input" value="60" style="width:120px">
            <button class="btn btn-primary" onclick="addTimeToUser()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
              Add Time
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">User Management</h3>
          <button class="btn-icon" onclick="loadUsers()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Username</th><th>Role</th><th>Balance</th><th>Status</th><th>Joined</th><th>Actions</th></tr>
              </thead>
              <tbody id="users-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs View -->
    <div id="view-logs" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">System Events</h3>
          <button class="btn-icon" onclick="loadLogs()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Time</th><th>Type</th><th>User</th><th>Details</th><th>IP</th></tr>
              </thead>
              <tbody id="logs-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tokens View -->
    <div id="view-tokens" class="view">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Add GitHub Token</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <input type="password" id="new-token" class="input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="flex:1;min-width:300px">
            <button class="btn btn-primary" onclick="addToken()" id="btn-add-token">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 5v14M5 12h14"/></svg>
              Add Token
            </button>
          </div>
          <p style="margin-top:12px;font-size:0.8rem;color:var(--text-muted)">Token will be tested before saving (creates test repo, runs workflow, then deletes)</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Token Pool</h3>
          <button class="btn-icon" onclick="loadTokens()" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>
        </div>
        <div class="card-body no-padding">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Owner</th><th>Token</th><th>Status</th><th>Last Check</th><th>Actions</th></tr>
              </thead>
              <tbody id="tokens-list"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<div id="toast" class="toast"></div>

<script>
  // Constants
  const ADMINS = ['vanmanh', 'depchai'];
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  // Toast
  function showToast(msg, type = 'success') {
    const t = $('#toast');
    t.textContent = msg;
    t.className = `toast toast-${type} active`;
    setTimeout(() => t.classList.remove('active'), 3000);
  }

  // Auth Check
  function checkAdmin() {
    try {
      const u = JSON.parse(localStorage.getItem('cc_current_user'));
      if (!u || !ADMINS.includes(u.username.toLowerCase())) {
        location.href = 'index.html';
        return;
      }
      $('#admin-name').textContent = u.username;
      $('#admin-avatar').textContent = u.username[0].toUpperCase();
    } catch {
      location.href = 'login.html';
    }
  }
  checkAdmin();

  // Sidebar Toggle
  function toggleSidebar() {
    $('#sidebar').classList.toggle('open');
    $('#overlay').classList.toggle('active');
  }

  // Navigation
  $$('.nav-item[data-tab]').forEach(btn => {
    btn.onclick = () => {
      $$('.nav-item').forEach(n => n.classList.remove('active'));
      btn.classList.add('active');
      $$('.view').forEach(v => v.classList.remove('active'));
      $(`#view-${btn.dataset.tab}`).classList.add('active');
      $('#page-title').textContent = btn.textContent.trim().split('\n')[0];
      
      if (window.innerWidth <= 1024) toggleSidebar();
      
      // Load data
      if (btn.dataset.tab === 'dashboard') loadDashboard();
      if (btn.dataset.tab === 'vps') loadVPS();
      if (btn.dataset.tab === 'users') loadUsers();
      if (btn.dataset.tab === 'logs') loadLogs();
      if (btn.dataset.tab === 'tokens') loadTokens();
    };
  });

  // Helper: Format date
  function formatDate(d) {
    if (!d) return '-';
    const date = new Date(d);
    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }) + ' ' + 
           date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  }

  // Helper: Truncate text
  function truncate(str, len = 50) {
    if (!str) return '-';
    return str.length > len ? str.slice(0, len) + '...' : str;
  }

  // Helper: Log type badge
  function logBadge(type) {
    const badges = {
      'login': 'badge-blue',
      'admin_login': 'badge-purple',
      'register': 'badge-green',
      'vps_created': 'badge-blue',
      'vps_deleted': 'badge-red',
      'vps_auto_deleted': 'badge-orange',
      'ban': 'badge-red',
      'unban': 'badge-green',
      'updateTime': 'badge-purple',
      'error': 'badge-red'
    };
    return `<span class="badge ${badges[type] || 'badge-gray'}">${type}</span>`;
  }

  // === DASHBOARD ===
  async function loadDashboard() {
    try {
      // Load all data
      const [vpsRes, usersRes, logsRes, tokensRes] = await Promise.all([
        fetch('/api/active-vps').then(r => r.json()),
        fetch('/api/auth', { method: 'POST', body: JSON.stringify({ action: 'getAllUsers' }) }).then(r => r.json()),
        fetch('/api/logs').then(r => r.json()),
        fetch('/api/tokens', { method: 'POST', body: JSON.stringify({ action: 'list' }) }).then(r => r.json())
      ]);

      const vpsCount = vpsRes.items?.length || 0;
      const userCount = usersRes.users?.length || 0;
      const liveTokens = (tokensRes.items || []).filter(t => t.status === 'live').length;
      const todayLogs = (logsRes.items || []).filter(l => {
        const d = new Date(l.at);
        const today = new Date();
        return d.toDateString() === today.toDateString();
      }).length;

      $('#stat-vps').textContent = vpsCount;
      $('#stat-users').textContent = userCount;
      $('#stat-tokens').textContent = liveTokens;
      $('#stat-logs').textContent = todayLogs;
      $('#vps-count').textContent = vpsCount;

      // Recent activity
      const tbody = $('#recent-activity');
      tbody.innerHTML = '';
      const recentLogs = (logsRes.items || []).slice(0, 10);
      
      if (recentLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No recent activity</td></tr>';
        return;
      }

      recentLogs.forEach(log => {
        const tr = document.createElement('tr');
        let details = '';
        if (log.type === 'vps_created') details = `Created ${log.repo}`;
        else if (log.type === 'login') details = 'Logged in';
        else if (log.type === 'register') details = 'Registered';
        else if (log.type === 'ban') details = `Banned ${log.target}`;
        else details = log.operation || log.type;

        tr.innerHTML = `
          <td class="mono">${formatDate(log.at)}</td>
          <td>${logBadge(log.type)}</td>
          <td><strong>${log.username || log.target || '-'}</strong></td>
          <td>${truncate(details, 40)}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('Dashboard error:', e);
    }
  }

  // === VPS ===
  async function loadVPS() {
    try {
      const res = await fetch('/api/active-vps');
      const data = await res.json();
      const items = data.items || [];

      $('#stat-vps').textContent = items.length;
      $('#vps-count').textContent = items.length;

      const tbody = $('#vps-list');
      tbody.innerHTML = '';

      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No running VPS instances</td></tr>';
        return;
      }

      items.forEach(vps => {
        const expires = new Date(vps.expiresAt);
        const now = Date.now();
        const remainingMs = expires - now;
        const remainingMin = Math.max(0, Math.round(remainingMs / 60000));
        const totalMin = vps.durationMinutes || 60;
        const percent = Math.max(0, Math.min(100, (remainingMin / totalMin) * 100));

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${vps.owner}</strong></td>
          <td class="mono">${vps.repo}</td>
          <td><span class="badge badge-blue">${vps.planId || 'Standard'}</span></td>
          <td class="mono">${formatDate(vps.createdAt)}</td>
          <td>
            <div style="min-width:100px">
              <span style="font-weight:600;color:${remainingMin < 10 ? 'var(--error)' : 'var(--text-primary)'}">${remainingMin}m</span>
              <div class="time-bar"><div class="time-bar-fill" style="width:${percent}%"></div></div>
            </div>
          </td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="killVPS('${vps.owner}','${vps.repo}')">Kill</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('VPS error:', e);
    }
  }

  async function killVPS(owner, repo) {
    if (!confirm(`Kill VPS ${repo}?`)) return;
    try {
      const res = await fetch('/api/delete-vps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ owner, repo })
      });
      const data = await res.json();
      if (data.success) {
        showToast('VPS deleted');
        loadVPS();
      } else {
        showToast(data.message || 'Error', 'error');
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  async function runCronCleanup() {
    showToast('Running cleanup...');
    try {
      const res = await fetch('/api/cron');
      const data = await res.json();
      showToast(`Cleaned ${data.vpsCleanup?.deleted || 0} VPS`);
      loadVPS();
    } catch (e) {
      showToast('Cleanup failed', 'error');
    }
  }

  // === USERS ===
  async function loadUsers() {
    try {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getAllUsers' })
      });
      const data = await res.json();
      const users = data.users || [];

      $('#stat-users').textContent = users.length + ADMINS.length;

      const tbody = $('#users-list');
      tbody.innerHTML = '';

      // Add hardcoded admins first
      ADMINS.forEach(admin => {
        const exists = users.find(u => u.username === admin);
        if (!exists) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${admin}</strong></td>
            <td><span class="badge badge-purple">ADMIN</span></td>
            <td>0m</td>
            <td><span class="badge badge-green">ACTIVE</span></td>
            <td>-</td>
              <div style="display:flex;gap:6px">
                <button class="btn btn-success btn-sm" onclick="quickAddTime('${admin}', 60)">+60m</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        }
      });

      users.forEach(u => {
        const isAdmin = ADMINS.includes(u.username) || u.isAdmin;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${u.username}</strong></td>
          <td>${isAdmin ? '<span class="badge badge-purple">ADMIN</span>' : '<span class="badge badge-gray">USER</span>'}</td>
          <td><span style="color:var(--success);font-weight:600">${u.timeMinutes}m</span></td>
          <td>${u.isBanned ? '<span class="badge badge-red">BANNED</span>' : '<span class="badge badge-green">ACTIVE</span>'}</td>
          <td class="mono">${formatDate(u.createdAt)}</td>
          <td>
            <div style="display:flex;gap:6px">
              <button class="btn btn-success btn-sm" onclick="quickAddTime('${u.username}', 60)">+60m</button>
              ${!isAdmin ? (u.isBanned 
                ? `<button class="btn btn-ghost btn-sm" onclick="unbanUser('${u.username}')">Unban</button>`
                : `<button class="btn btn-danger btn-sm" onclick="banUser('${u.username}')">Ban</button>`
              ) : ''}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('Users error:', e);
    }
  }

  async function addTimeToUser() {
    const username = $('#time-username').value.trim();
    const minutes = parseInt($('#time-minutes').value) || 60;
    if (!username) return showToast('Enter username', 'error');
    await quickAddTime(username, minutes);
    $('#time-username').value = '';
  }

  async function quickAddTime(username, minutes) {
    try {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'updateTime', username, minutes, operation: 'add' })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`Added ${minutes}m to ${username}`);
        loadUsers();
      } else {
        showToast(data.message || 'Error', 'error');
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  async function banUser(username) {
    if (!confirm(`Ban ${username} permanently?`)) return;
    try {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'banUser', targetUsername: username, banUnit: 'permanent' })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`Banned ${username}`);
        loadUsers();
      } else {
        showToast(data.message || 'Error', 'error');
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  async function unbanUser(username) {
    try {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'unbanUser', targetUsername: username })
      });
      const data = await res.json();
      if (data.success) {
        showToast(`Unbanned ${username}`);
        loadUsers();
      } else {
        showToast(data.message || 'Error', 'error');
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  // === LOGS ===
  async function loadLogs() {
    try {
      const res = await fetch('/api/logs');
      const data = await res.json();
      const items = data.items || [];

      const tbody = $('#logs-list');
      tbody.innerHTML = '';

      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No logs yet</td></tr>';
        return;
      }

      items.slice(0, 100).forEach(log => {
        let details = '';
        if (log.type === 'vps_created') details = `${log.repo} (${log.durationMinutes}m)`;
        else if (log.type === 'login' || log.type === 'admin_login') details = 'Logged in';
        else if (log.type === 'register') details = log.banned ? 'Registered (banned)' : 'Registered';
        else if (log.type === 'ban') details = `${log.target} - ${log.unit}`;
        else if (log.type === 'unban') details = log.target;
        else if (log.type === 'updateTime') details = `${log.operation} ${log.minutes}m`;
        else if (log.type === 'vps_deleted' || log.type === 'vps_auto_deleted') details = log.repo;
        else details = JSON.stringify(log).slice(0, 60);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${formatDate(log.at)}</td>
          <td>${logBadge(log.type)}</td>
          <td><strong>${log.username || log.target || '-'}</strong></td>
          <td style="color:var(--text-muted)">${truncate(details, 50)}</td>
          <td class="mono" style="font-size:0.8rem;color:var(--text-muted)">${log.ip || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('Logs error:', e);
    }
  }

  // === TOKENS ===
  async function loadTokens() {
    try {
      const res = await fetch('/api/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'list' })
      });
      const data = await res.json();
      const items = data.items || [];

      const liveCount = items.filter(t => t.status === 'live').length;
      $('#stat-tokens').textContent = liveCount;

      const tbody = $('#tokens-list');
      tbody.innerHTML = '';

      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No tokens added yet</td></tr>';
        return;
      }

      items.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${t.owner || 'Unknown'}</strong></td>
          <td class="mono">${t.masked}</td>
          <td>${t.status === 'live' 
            ? '<span class="badge badge-green">LIVE</span>' 
            : '<span class="badge badge-red">DEAD</span>'}</td>
          <td class="mono" style="font-size:0.8rem">${t.lastChecked ? formatDate(t.lastChecked) : '-'}</td>
          <td>
            <div style="display:flex;gap:6px">
              <button class="btn btn-ghost btn-sm" onclick="checkToken('${t.id}')">Check</button>
              <button class="btn btn-danger btn-sm" onclick="deleteToken('${t.id}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('Tokens error:', e);
    }
  }

  async function addToken() {
    const token = $('#new-token').value.trim();
    if (!token) return showToast('Enter a token', 'error');

    const btn = $('#btn-add-token');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Testing...';
    btn.disabled = true;

    try {
      const res = await fetch('/api/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'add', token })
      });
      const data = await res.json();
      
      if (data.success) {
        showToast(data.message);
        $('#new-token').value = '';
        loadTokens();
      } else {
        showToast(data.message || 'Token is dead', 'error');
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  async function checkToken(id) {
    showToast('Checking token...');
    try {
      const res = await fetch('/api/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'check', id })
      });
      const data = await res.json();
      showToast(data.message, data.live ? 'success' : 'error');
      loadTokens();
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  async function deleteToken(id) {
    if (!confirm('Delete this token?')) return;
    try {
      const res = await fetch('/api/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', id })
      });
      const data = await res.json();
      if (data.success) {
        showToast('Token deleted');
        loadTokens();
      }
    } catch (e) {
      showToast('Error: ' + e.message, 'error');
    }
  }

  // Initial load
  loadDashboard();
</script>
</body>
</html>